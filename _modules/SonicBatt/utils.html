<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SonicBatt.utils &#8212; SonicBatt 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for SonicBatt.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow.parquet</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pq</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>

<div class="viewcode-block" id="root_dir">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.root_dir">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">root_dir</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="s1">&#39;--show-toplevel&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">root</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Pulse">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.Pulse">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Pulse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contains information for single pulses.</span>
<span class="sd">    &quot;C&quot; indicates a step where current is not zero.</span>
<span class="sd">    &quot;R&quot; indicates a rest step.&lt;br&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Index labelling:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Temperature info:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_stdev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_temp_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_temp_stdev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_temp_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_temp_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># OCV &amp; mAh info:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_OCV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_mAh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_end_OCV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_end_mAh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Resistance info:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_R0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_R0_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_R0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_R0_dt</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="PulseSequence">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.PulseSequence">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PulseSequence</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1">#Pulse_list will be a list of Pulse objects    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pulse_list</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Acoustic_Pulse">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.Acoustic_Pulse">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Acoustic_Pulse</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Contains information for single pulses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Index labelling:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_pre_start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_pre_end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Temperature info:</span>
        <span class="c1"># During pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_stdev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Relaxation post pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_temp_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_temp_stdev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_temp_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_temp_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_start_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_end_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Relaxation pre pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_pre_temp_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># OCV &amp; mAh info:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_pre_end_OCV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_pre_end_mAh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_OCV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_mAh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_end_OCV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_end_mAh</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Acoustic_PulseSequence">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.Acoustic_PulseSequence">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Acoustic_PulseSequence</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1">#Pulse_list will be a list of Pulse objects    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Acoustic_Pulse_list</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="EIS_object">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.EIS_object">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EIS_object</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eis_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eis_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eis_start_datetime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_ind</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Latest index from df_cycling</span>
        <span class="c1"># For studies doing EIS repetitions:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_step</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="EIS_sequence">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.EIS_sequence">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EIS_sequence</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EIS_list</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Acoustic_p2C">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.Acoustic_p2C">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Acoustic_p2C</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_ind_list</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Protocol_custom_objects">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.Protocol_custom_objects">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Protocol_custom_objects</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cell_Q</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">P_char_chrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">P_char_dischrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">EIS_char_chrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">EIS_char_dischrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">EIS_other_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Acoustic_char_chrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Acoustic_char_dischrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_id</span> <span class="o">=</span> <span class="n">test_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_Q</span> <span class="o">=</span> <span class="n">cell_Q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_char_chrg_seq</span> <span class="o">=</span> <span class="n">P_char_chrg_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_char_dischrg_seq</span> <span class="o">=</span> <span class="n">P_char_dischrg_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EIS_char_chrg_seq</span> <span class="o">=</span> <span class="n">EIS_char_chrg_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EIS_char_dischrg_seq</span> <span class="o">=</span> <span class="n">EIS_char_dischrg_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EIS_other_seq</span> <span class="o">=</span> <span class="n">EIS_other_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Acoustic_char_chrg_seq</span> <span class="o">=</span> <span class="n">Acoustic_char_chrg_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Acoustic_char_dischrg_seq</span> <span class="o">=</span> <span class="n">Acoustic_char_dischrg_seq</span></div>


<div class="viewcode-block" id="json_to_custom_object">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.json_to_custom_object">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">json_to_custom_object</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_attributes</span><span class="p">(</span><span class="n">custom_object</span><span class="p">):</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="n">custom_object</span><span class="p">)</span>
        <span class="n">selected_attributes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="c1"># Ensure they are not default pyhton attributes</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;__&#39;</span><span class="p">):</span>
                <span class="n">selected_attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">selected_attributes</span><span class="p">)</span>

    <span class="n">custom_object</span> <span class="o">=</span> <span class="n">Protocol_custom_objects</span><span class="p">()</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">get_attributes</span><span class="p">(</span><span class="n">custom_object</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;Acoustic_char_chrg_seq&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;Acoustic_char_dischrg_seq&#39;</span><span class="p">))</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">attr</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">iterable</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">custom_object</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">Acoustic_PulseSequence</span><span class="p">())</span>
            <span class="n">pulse_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">n_pulses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;Acoustic_Pulse_list&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pulses</span><span class="p">):</span>
                <span class="n">pulse_dict</span> <span class="o">=</span> <span class="n">iterable</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;Acoustic_Pulse_list&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">new_obj</span> <span class="o">=</span> <span class="n">Acoustic_Pulse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pulse_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">pulse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>
            
            <span class="nb">getattr</span><span class="p">(</span><span class="n">custom_object</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">Acoustic_Pulse_list</span> <span class="o">=</span> <span class="n">pulse_list</span>
            <span class="k">for</span> <span class="n">attr_2</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">attr_2</span> <span class="o">!=</span> <span class="s1">&#39;Acoustic_Pulse_list&#39;</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">custom_object</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">attr_2</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">((</span><span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;P_char_chrg_seq&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;P_char_dischrg_seq&#39;</span><span class="p">))</span> <span class="o">&amp;</span> \
            <span class="p">(</span><span class="n">attr</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">iterable</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">custom_object</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">PulseSequence</span><span class="p">())</span>
            <span class="n">pulse_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">n_pulses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;Pulse_list&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pulses</span><span class="p">):</span>
                <span class="n">pulse_dict</span> <span class="o">=</span> <span class="n">iterable</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;Pulse_list&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">new_obj</span> <span class="o">=</span> <span class="n">Pulse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pulse_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">pulse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">custom_object</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">Pulse_list</span> <span class="o">=</span> <span class="n">pulse_list</span>
            <span class="k">for</span> <span class="n">attr_2</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">attr_2</span> <span class="o">!=</span> <span class="s1">&#39;Pulse_list&#39;</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">custom_object</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">attr_2</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;EIS_other_seq&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">attr</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">iterable</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">iterable</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">custom_object</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">EIS_sequence</span><span class="p">())</span>
                <span class="n">eis_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">n_pulses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;EIS_list&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pulses</span><span class="p">):</span>
                    <span class="n">eis_dict</span> <span class="o">=</span> <span class="n">iterable</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;EIS_list&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">eis_df_dict</span> <span class="o">=</span> <span class="n">eis_dict</span><span class="p">[</span><span class="s1">&#39;eis_df&#39;</span><span class="p">]</span>
                    <span class="n">new_obj</span> <span class="o">=</span> <span class="n">EIS_object</span><span class="p">()</span>
                    <span class="n">new_obj</span><span class="o">.</span><span class="n">eis_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">eis_df_dict</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">eis_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;eis_df&#39;</span><span class="p">:</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>               
                    <span class="n">eis_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">custom_object</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">EIS_list</span> <span class="o">=</span> <span class="n">eis_list</span>
                <span class="k">for</span> <span class="n">attr_2</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">attr_2</span> <span class="o">!=</span> <span class="s1">&#39;EIS_list&#39;</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">custom_object</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">attr_2</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># Special case for &#39;Acoustic_p2C&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;Acoustic_p2C&#39;</span> <span class="ow">in</span> <span class="n">iterable</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">custom_object</span><span class="o">.</span><span class="n">Acoustic_p2C</span> <span class="o">=</span> <span class="n">Acoustic_p2C</span><span class="p">()</span>
            <span class="n">custom_object</span><span class="o">.</span><span class="n">Acoustic_p2C</span><span class="o">.</span><span class="n">start_ind</span> <span class="o">=</span> <span class="n">iterable</span><span class="p">[</span><span class="s1">&#39;Acoustic_p2C&#39;</span><span class="p">][</span><span class="s1">&#39;start_ind&#39;</span><span class="p">]</span>
            <span class="n">custom_object</span><span class="o">.</span><span class="n">Acoustic_p2C</span><span class="o">.</span><span class="n">end_ind</span> <span class="o">=</span> <span class="n">iterable</span><span class="p">[</span><span class="s1">&#39;Acoustic_p2C&#39;</span><span class="p">][</span><span class="s1">&#39;end_ind&#39;</span><span class="p">]</span>
            <span class="n">custom_object</span><span class="o">.</span><span class="n">Acoustic_p2C</span><span class="o">.</span><span class="n">ignore_ind_list</span> <span class="o">=</span> <span class="n">iterable</span><span class="p">[</span><span class="s1">&#39;Acoustic_p2C&#39;</span><span class="p">][</span><span class="s1">&#39;ignore_ind_list&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">custom_object</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_custom_object">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.create_custom_object">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_custom_object</span><span class="p">(</span><span class="n">test_id</span><span class="p">,</span> <span class="n">test_dir</span><span class="p">):</span>
    <span class="c1"># Protocol object</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_Protocol_objects.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_id</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json_string</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">Protocol_objects_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
    <span class="n">custom_object</span> <span class="o">=</span> <span class="n">json_to_custom_object</span><span class="p">(</span><span class="n">Protocol_objects_json</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">custom_object</span></div>


<div class="viewcode-block" id="smooth_by_convolution">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.smooth_by_convolution">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">smooth_by_convolution</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="s1">&#39;rectangular&#39;</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - s is a single signal.</span>
<span class="sd">    It is prepared by introducing reflected copies of the signal in both ends so that</span>
<span class="sd">    transient parts are minimized in the begining and end part of the output signal.</span>
<span class="sd">    Those copies have length window_len.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">window_len</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># !!! Window_len must be an odd number.</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extend_signal</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        mirrored parts of the signal are introduced at the beginning and end of it.</span>
<span class="sd">        the mirroring is wrt both axes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extra_front_bit</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[</span><span class="n">window_len</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">extra_tail_bit</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">window_len</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s_extended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">extra_front_bit</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">extra_tail_bit</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s_extended</span><span class="p">)</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="n">s_extended</span> <span class="o">=</span> <span class="n">extend_signal</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kernel_type</span><span class="o">==</span><span class="s1">&#39;rectangular&#39;</span><span class="p">:</span>
        <span class="c1"># Equivalent to a moving average</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_len</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">kernel_type</span><span class="o">==</span><span class="s1">&#39;triangular&#39;</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_len</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_len</span><span class="o">/</span><span class="mi">2</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">kernel_type</span><span class="o">==</span><span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">window_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">window_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">passes</span><span class="p">):</span>
        <span class="n">s_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">s_extended</span><span class="p">,</span> <span class="n">kernel</span> <span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">s_smooth</span> <span class="o">=</span> <span class="n">s_smooth</span><span class="p">[</span><span class="n">window_len</span><span class="p">:</span><span class="o">-</span><span class="n">window_len</span><span class="p">]</span>
        <span class="n">s_extended</span> <span class="o">=</span> <span class="n">extend_signal</span><span class="p">(</span><span class="n">s_smooth</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_smooth</span><span class="p">)</span></div>


<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_peaks</span>
<div class="viewcode-block" id="signal_peaks">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.signal_peaks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">signal_peaks</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">crop_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="s1">&#39;triangular&#39;</span><span class="p">,</span>
    <span class="n">n_selected_peaks</span> <span class="o">=</span> <span class="mi">9</span><span class="p">):</span>
    <span class="c1">###</span>
    <span class="n">peak_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">),</span> <span class="n">n_selected_peaks</span><span class="p">))</span>
    <span class="n">peak_heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">),</span> <span class="n">n_selected_peaks</span><span class="p">))</span>
    <span class="n">progress_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">pct_progress</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Smoothing signals. Passes = </span><span class="si">{}</span><span class="s1">. Window_len = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">passes</span><span class="p">,</span> <span class="n">window_len</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">signals</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="o">&gt;</span> <span class="n">pct_progress</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{pct:.2f}</span><span class="s1"> %&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pct</span> <span class="o">=</span> <span class="n">pct_progress</span><span class="p">))</span>
            <span class="n">pct_progress</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">progress_iterator</span><span class="p">)</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">s_smooth</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="n">kernel_type</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="n">passes</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">indices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">s_smooth</span><span class="p">[</span><span class="n">crop_ind</span><span class="p">:])</span>
        <span class="n">indices</span> <span class="o">+=</span> <span class="n">crop_ind</span>
        <span class="n">heights</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="n">first_few_heights</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[:</span><span class="n">n_selected_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">first_few_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">n_selected_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">echo_peak_i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">heights</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">):])</span>
        <span class="n">echo_peak_height</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[</span><span class="n">echo_peak_i</span><span class="p">]</span>
        <span class="n">echo_peak_index</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">echo_peak_i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">echo_peak_index</span> <span class="o">&gt;</span> <span class="n">first_few_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">echo_peak_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">echo_peak_height</span><span class="p">])</span>
            <span class="n">echo_peak_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">echo_peak_index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo_peak_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
            <span class="n">echo_peak_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
        <span class="n">peak_heights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">first_few_heights</span><span class="p">,</span> <span class="n">echo_peak_height</span><span class="p">))</span>
        <span class="n">peak_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">first_few_indices</span><span class="p">,</span> <span class="n">echo_peak_index</span><span class="p">))</span>
    <span class="n">index_to_tof_ratio</span> <span class="o">=</span> <span class="mi">10</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">s_smooth</span><span class="p">)</span>
    <span class="n">peak_tofs</span> <span class="o">=</span> <span class="n">peak_indices</span> <span class="o">*</span> <span class="n">index_to_tof_ratio</span>
    <span class="k">return</span> <span class="n">peak_heights</span><span class="p">,</span> <span class="n">peak_tofs</span></div>


<div class="viewcode-block" id="df_with_peaks">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.df_with_peaks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">df_with_peaks</span><span class="p">(</span>
    <span class="n">data_path</span><span class="p">,</span> <span class="n">test_id</span><span class="p">,</span> <span class="n">slicing_indices</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">ignore_ind_list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">n_peaks</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">,</span> 
    <span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
    <span class="n">pk_headings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_peaks</span><span class="p">))</span>
    <span class="n">pk_headings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pk_headings</span><span class="p">))</span>

    <span class="n">parquet_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_acoustics_and_cycling.parquet&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_id</span><span class="p">)</span>
    <span class="n">parquet_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">test_id</span><span class="p">,</span> <span class="n">parquet_filename</span><span class="p">)</span>
    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">parquet_filepath</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">slicing_indices</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">slicing_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">slicing_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ignore_ind_list</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="o">~</span><span class="n">final_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ignore_ind_list</span><span class="p">)</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">]</span>
    <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Signal Processing</span>
    <span class="n">signals</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;acoustics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">signal_len</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">crop_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="n">signal_len</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">signals</span><span class="p">[:,:</span><span class="nb">int</span><span class="p">(</span><span class="n">signal_len</span><span class="o">/</span><span class="mi">5</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">peak_heights</span><span class="p">,</span> <span class="n">peak_tofs</span> <span class="o">=</span> <span class="n">signal_peaks</span><span class="p">(</span>
        <span class="n">signals</span><span class="p">,</span> <span class="n">crop_ind</span><span class="o">=</span><span class="n">crop_ind</span><span class="p">,</span> <span class="n">n_selected_peaks</span><span class="o">=</span><span class="n">n_peaks</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="n">pk_heights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">peak_heights</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">pk_headings</span><span class="p">)</span>
    <span class="n">pk_tofs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">peak_tofs</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">pk_headings</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">],</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;acoustics&#39;</span><span class="p">],</span> <span class="n">pk_heights</span><span class="p">,</span> <span class="n">pk_tofs</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">,</span> <span class="s1">&#39;acoustics&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_heights&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_tofs&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="save_figure">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.save_figure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">visualisation_path</span><span class="p">,</span> <span class="n">save_filename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Type can be pdf. If any other value is specified a png will be saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">visualisation_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">visualisation_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span><span class="o">!=</span><span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span>
        <span class="n">save_filename</span> <span class="o">+=</span> <span class="s1">&#39;.png&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">save_filename</span> <span class="o">+=</span> <span class="s1">&#39;.pdf&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">visualisation_path</span><span class="p">,</span> <span class="n">save_filename</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_spectrogram">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.make_spectrogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_spectrogram</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">frame_length</span><span class="o">=</span><span class="mi">501</span><span class="p">,</span> <span class="n">frame_step</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">pad_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crop_freq</span> <span class="o">=</span> <span class="mi">21</span><span class="p">):</span>
    <span class="c1"># Convert the waveform to a spectrogram via a STFT.</span>
    <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span>
        <span class="n">waveform</span><span class="p">,</span> <span class="n">frame_length</span><span class="o">=</span><span class="n">frame_length</span><span class="p">,</span> <span class="n">frame_step</span><span class="o">=</span><span class="n">frame_step</span><span class="p">,</span> <span class="n">pad_end</span><span class="o">=</span><span class="n">pad_end</span><span class="p">)</span>
    <span class="c1"># Obtain the magnitude of the STFT.</span>
    <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">)</span>
    <span class="c1"># Add a `channels` dimension, so that the spectrogram can be used</span>
    <span class="c1"># as image-like input data with convolution layers (which expect</span>
    <span class="c1"># shape (`batch_size`, `height`, `width`, `channels`).</span>
    <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="c1"># print(spectrogram.shape)</span>
    <span class="c1"># print(&#39;N features = {}&#39;.format(spectrogram.shape[0]*spectrogram.shape[1]))</span>
    <span class="k">if</span> <span class="n">crop_freq</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="n">crop_freq</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">spectrogram</span></div>


<div class="viewcode-block" id="spectrogram_data_for_plot">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.spectrogram_data_for_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spectrogram_data_for_plot</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">):</span>
    <span class="c1"># If needed, remove the last axis which is for ML</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">log_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">spectrogram</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log_spec</span></div>


<div class="viewcode-block" id="animate_signals">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.animate_signals">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">animate_signals</span><span class="p">(</span><span class="n">df_cycling</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">fft_magns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">freqs_MHz</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">drc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">peak_heights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">peak_tofs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crop_ind</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">temp_lims</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">32</span><span class="p">),</span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mf">4.8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">annot_pos</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_step</span><span class="o">=</span><span class="mf">2.5e-03</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    https://jckantor.github.io/CBE30338/A.03-Animation-in-Jupyter-Notebooks.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Some data and exception handling</span>
    <span class="c1">#---------------------------------</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fft_magns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">freqs_MHz</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Provide_frequencies in MHz to accompany the fft_magns input&#39;</span><span class="p">)</span>
    <span class="n">voltages</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s2">&quot;V(V)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">temperatures</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s2">&quot;Temp(degC)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">drc</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s2">&quot;C-Rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;CV&#39;</span> <span class="ow">in</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s1">&#39;Regime&#39;</span><span class="p">]:</span>
            <span class="n">cv_filter</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s1">&#39;Regime&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CV&#39;</span>
            <span class="n">rates</span><span class="p">[</span><span class="n">cv_filter</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;CV&#39;</span>
        <span class="n">rate_cols</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;CV&#39;</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">}</span>
    <span class="n">anim_indices</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># Create the background frame</span>
    <span class="c1">#----------------------------</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fft_magns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]},</span>
            <span class="n">constrained_layout</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annot_pos</span> <span class="o">==</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">annot_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>       
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fft_magns</span> <span class="o">/=</span> <span class="mi">1000</span> <span class="c1"># To make the axes plotting it look nicer.</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">4</span><span class="p">]},</span>
            <span class="n">constrained_layout</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
        <span class="n">line_freq_domain</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annot_pos</span> <span class="o">==</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">annot_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">crop_ind</span><span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">line1_time_domain</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
    <span class="n">line2_time_domain</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
    <span class="n">barV</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">barT</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">peak_heights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">n_peaks</span> <span class="o">=</span> <span class="n">peak_heights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">peaks_colorscheme</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">Greens</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peaks</span><span class="p">))</span>
        <span class="n">scat_peaks</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_peaks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_peaks</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">peaks_colorscheme</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;tab:green&#39;</span><span class="p">)</span>   
    <span class="n">my_text</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">annot_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">annot_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">backgroundcolor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>    
    <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">18</span>
    <span class="c1"># axs[0] (line: time domain)</span>
    <span class="n">time_domain_value_range</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">signals</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">time_domain_value_range</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>       
        <span class="n">signals</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ToF (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Acoustic Amplitude (a.u.)&#39;</span><span class="p">)</span>
    <span class="c1"># axs[1] (bar)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">4.4</span><span class="p">)</span>
    <span class="c1"># axs[2] (bar)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">temp_lims</span><span class="p">)</span>
    <span class="c1"># axs[3] (line: freq domain)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fft_magns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">freq_domain_value_range</span> <span class="o">=</span> <span class="n">fft_magns</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">fft_magns</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">freq_domain_value_range</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">fft_magns</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">fft_magns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.05</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">offset</span><span class="p">,</span> <span class="n">fft_magns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">freqs_MHz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freqs_MHz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;MHz&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;FFT magn. x 1000</span><span class="se">\n</span><span class="s1">(a.u.)&#39;</span><span class="p">)</span>
    <span class="c1"># General</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">title_font_size</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">align_ylabels</span><span class="p">()</span>

    <span class="c1"># TO help produce a progress update</span>
    <span class="n">progress_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">100.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">global</span> <span class="n">pct_progress</span>
    <span class="n">pct_progress</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># animation function. This is called sequentially</span>
    <span class="c1"># -----------------------------------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">drawframe</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="c1"># Print progress information</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">anim_indices</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="o">&gt;</span> <span class="nb">globals</span><span class="p">()[</span><span class="s2">&quot;pct_progress&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{pct:.2f}</span><span class="s1"> %&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pct</span> <span class="o">=</span> <span class="n">pct_progress</span><span class="p">))</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="s2">&quot;pct_progress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">progress_iterator</span><span class="p">)</span>

        <span class="n">x_time_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span> <span class="o">*</span> <span class="n">time_step</span> <span class="o">+</span> <span class="n">time_step</span> <span class="c1"># The first datapoint logged is at time_step, not zero.</span>
        <span class="k">if</span> <span class="n">crop_ind</span><span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">x1_time_domain</span> <span class="o">=</span> <span class="n">x_time_domain</span><span class="p">[:</span><span class="n">crop_ind</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">y1_time_domain</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:</span><span class="n">crop_ind</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">x2_time_domain</span> <span class="o">=</span> <span class="n">x_time_domain</span><span class="p">[</span><span class="n">crop_ind</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">y2_time_domain</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">crop_ind</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">line1_time_domain</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x1_time_domain</span><span class="p">,</span> <span class="n">y1_time_domain</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x2_time_domain</span> <span class="o">=</span> <span class="n">x_time_domain</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">y2_time_domain</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">line2_time_domain</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x2_time_domain</span><span class="p">,</span> <span class="n">y2_time_domain</span><span class="p">)</span>
        <span class="c1">## axs[1] (bar)</span>
        <span class="n">volts</span> <span class="o">=</span> <span class="n">voltages</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">barV</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="n">volts</span><span class="p">)</span>
        <span class="c1">## axs[2] (bar)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temperatures</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">barT</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="c1">## ax4 (line: freq domain)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fft_magns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">fft_magn</span> <span class="o">=</span> <span class="n">fft_magns</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">line_freq_domain</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fft_magn</span><span class="p">)),</span> <span class="n">fft_magn</span><span class="p">)</span>
            <span class="n">line_freq_domain</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">freqs_MHz</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">fft_magn</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="c1">## Annotations</span>
        <span class="k">if</span> <span class="n">drc</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">text_col</span> <span class="o">=</span> <span class="n">rate_cols</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">my_text</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">text_col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rate</span> <span class="o">!=</span> <span class="s1">&#39;CV&#39;</span><span class="p">:</span>
                <span class="n">rate_annotation</span> <span class="o">=</span> <span class="s1">&#39;Signal Id: </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">Rate: </span><span class="si">%s</span><span class="s1"> C&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rate_annotation</span> <span class="o">=</span> <span class="s1">&#39;Signal Id: </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">Rate: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
            <span class="n">my_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">rate_annotation</span><span class="p">)</span>    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">my_text</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">my_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;Signal Id: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">peak_heights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">x_scat</span> <span class="o">=</span> <span class="n">peak_tofs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">y_scat</span> <span class="o">=</span> <span class="n">peak_heights</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">scat_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x_scat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_scat</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">y_scat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_scat</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">scat_peaks</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">(</span><span class="n">scat_array</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line2_time_domain</span><span class="p">,</span> <span class="n">barV</span><span class="p">,</span> <span class="n">barT</span><span class="p">,</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.animation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">animation</span>
    <span class="c1"># interval is the delay between frames in milliseconds.</span>
    <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">drawframe</span><span class="p">,</span> <span class="n">interval</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">anim_indices</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">save_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.mp4&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ani</span></div>


<div class="viewcode-block" id="animate_spectrograms">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.animate_spectrograms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">animate_spectrograms</span><span class="p">(</span><span class="n">df_cycling</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">temp_lims</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">32</span><span class="p">),</span>
                        <span class="n">frame_length</span><span class="o">=</span><span class="mi">501</span><span class="p">,</span> <span class="n">frame_step</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">crop_freq</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    specs means spectrograms (a 3D numpy array)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_step</span><span class="o">=</span><span class="mf">2.5e-03</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">frame_length</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">time_step</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">crop_freq</span><span class="p">]</span>
    <span class="n">voltages</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s2">&quot;V(V)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">temperatures</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s2">&quot;Temp(degC)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">rates</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s2">&quot;C-Rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;CV&#39;</span> <span class="ow">in</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s1">&#39;Regime&#39;</span><span class="p">]:</span>
        <span class="n">cv_filter</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s1">&#39;Regime&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CV&#39;</span>
        <span class="n">rates</span><span class="p">[</span><span class="n">cv_filter</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;CV&#39;</span>
    <span class="n">rate_cols</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;CV&#39;</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">}</span>
    <span class="n">annot_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span> 

    <span class="c1"># Create the background frame</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">4.8</span><span class="p">),</span>
            <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">4</span><span class="p">]},</span> <span class="n">constrained_layout</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="c1"># Line</span>
    <span class="n">line_time_domain</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
    <span class="c1"># Bars</span>
    <span class="n">barV</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">barT</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Spectrogram</span>
    <span class="n">specs_log_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">specs</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">specs_log_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">specs</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="n">init_spectrogram</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">log_spec</span> <span class="o">=</span> <span class="n">spectrogram_data_for_plot</span><span class="p">(</span><span class="n">init_spectrogram</span><span class="p">)</span>
    <span class="c1"># Plot the x values in the middle of the time window they represent.</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="mi">758</span><span class="o">*</span><span class="n">time_step</span> <span class="o">+</span> 
         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">log_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">frame_step</span><span class="p">)</span><span class="o">*</span><span class="n">time_step</span> <span class="o">+</span> 
         <span class="nb">round</span><span class="p">(</span><span class="n">frame_length</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">time_step</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">frame_length</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">time_step</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">crop_freq</span><span class="p">]</span> <span class="c1">#MHz</span>
    <span class="n">pcm</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">log_spec</span><span class="p">)</span>

    <span class="n">my_text</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">annot_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">annot_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">backgroundcolor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span> 

    <span class="c1"># Axes limits</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">time_step</span><span class="o">*</span><span class="mi">758</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">4.4</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">temp_lims</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">time_step</span><span class="o">*</span><span class="mi">758</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">time_domain_value_range</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">signals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">time_domain_value_range</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>       
        <span class="n">signals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
    
    <span class="c1"># Axes labels</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ToF (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Acoustic Amplitude (a.u.)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ToF (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency (MHz)&#39;</span><span class="p">)</span>

    <span class="c1"># General</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">18</span>
    <span class="n">f</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">title_font_size</span><span class="p">)</span>

    <span class="c1"># TO help produce a progress update</span>
    <span class="n">progress_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">100.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">global</span> <span class="n">pct_progress</span>
    <span class="n">pct_progress</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">drawframe</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="c1"># Print progress information</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df_cycling</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="o">&gt;</span> <span class="nb">globals</span><span class="p">()[</span><span class="s2">&quot;pct_progress&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{pct:.2f}</span><span class="s1"> %&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pct</span> <span class="o">=</span> <span class="n">pct_progress</span><span class="p">))</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="s2">&quot;pct_progress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">progress_iterator</span><span class="p">)</span>

        <span class="n">x_time_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span> <span class="o">*</span> <span class="n">time_step</span> <span class="o">+</span> <span class="n">time_step</span> <span class="c1"># The first datapoint logged is at time_step, not zero.</span>
        <span class="n">y_time_domain</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">line_time_domain</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_time_domain</span> <span class="o">+</span> <span class="n">time_step</span><span class="o">*</span><span class="mi">758</span><span class="p">,</span> <span class="n">y_time_domain</span><span class="p">)</span>

        <span class="n">volts</span> <span class="o">=</span> <span class="n">voltages</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">barV</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="n">volts</span><span class="p">)</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">temperatures</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">barT</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">log_spec</span> <span class="o">=</span> <span class="n">spectrogram_data_for_plot</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="c1"># pcm.set_data(X, Y, log_spec)</span>
        <span class="n">pcm</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">log_spec</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">pcm</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">log_spec</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">log_spec</span><span class="p">))</span>
        <span class="c1"># pcm.set_clim(vmin=specs_log_min, vmax=specs_log_max)</span>

        <span class="n">rate</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">text_col</span> <span class="o">=</span> <span class="n">rate_cols</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">my_text</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">text_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rate</span> <span class="o">!=</span> <span class="s1">&#39;CV&#39;</span><span class="p">:</span>
            <span class="n">rate_annotation</span> <span class="o">=</span> <span class="s1">&#39;Signal Id: </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">Rate: </span><span class="si">%s</span><span class="s1"> C&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rate_annotation</span> <span class="o">=</span> <span class="s1">&#39;Signal Id: </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">Rate: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
        <span class="n">my_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">rate_annotation</span><span class="p">)</span> 

        <span class="k">return</span> <span class="n">line_time_domain</span><span class="p">,</span> <span class="n">barV</span><span class="p">,</span> <span class="n">barT</span><span class="p">,</span> <span class="n">pcm</span><span class="p">,</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.animation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">animation</span>
    <span class="c1"># interval is the delay between frames in milliseconds.</span>
    <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">drawframe</span><span class="p">,</span> <span class="n">interval</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_cycling</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">save_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.mp4&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ani</span></div>


<span class="c1">#CCCV data plotting------------------------------------</span>
<span class="c1">#------------------------------------------------------</span>
<div class="viewcode-block" id="colorscheme">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.colorscheme">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">colorscheme</span><span class="p">(</span><span class="n">n_increments</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="n">cmap</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_increments</span><span class="p">))</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="multi_cell_plot">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.multi_cell_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">multi_cell_plot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">cell_aliases</span><span class="p">,</span> <span class="n">x_quantity</span> <span class="o">=</span> <span class="s1">&#39;Q(mAh)&#39;</span><span class="p">,</span> <span class="n">c_rates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xlims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">14.4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">relative_peaks</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">freqs_1d</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">freq_ind_pair</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">subtitle_font_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axlabels_font_size</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">ticksize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">label_text_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">save_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">visualisation_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">saveformat</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    df must be a pandas DataFrame which is multiindex with:</span>
<span class="sd">    df.columns.levels[0] = Index([&#39;cycling&#39;, &#39;acoustics&#39;, &#39;peak_heights&#39;, &#39;peak_tofs&#39;,</span>
<span class="sd">        &#39;fft_magns&#39;, &#39;fft_freq_indices_sorted&#39;], dtype=&#39;object&#39;)</span>
<span class="sd">    cell: A list of cell names as defined in the database.</span>
<span class="sd">    cell_aliases: A dictionary where the keys are the cell names and the values are cell_aliases</span>
<span class="sd">    - which will be used instead of the cell names used in the database.</span>
<span class="sd">    Options:</span>
<span class="sd">    domain: &#39;time&#39; or &#39;freq&#39;</span>
<span class="sd">        if &#39;time&#39;; </span>
<span class="sd">        - relative_peaks: Bool</span>
<span class="sd">        if &#39;freq&#39;; must also provide an array &#39;freqs_id&#39; of the frequencies in MHz</span>
<span class="sd">        - freq_ind_pair: provide the indices of two frequencies to plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_rates</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">c_rate_for_title</span> <span class="o">=</span> <span class="s1">&#39;C-rate = </span><span class="si">{}</span><span class="s1"> C.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_rates</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">c_rate_for_title</span>  <span class="o">=</span> <span class="s1">&#39;C-rates = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> C.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_rates</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">c_rate_for_title</span>  <span class="o">=</span> <span class="s1">&#39;C-rates = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> C.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c_rates</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">domain</span><span class="o">==</span><span class="s1">&#39;time&#39;</span><span class="p">:</span>
        <span class="n">n_peaks</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">relative_peaks</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">peak_2_tof_row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">peak_last_tof_row</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">y_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;Ampl. (a.u.)</span><span class="se">\n</span><span class="s1">(second peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Ampl. (a.u.)</span><span class="se">\n</span><span class="s1">(last peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Ampl. Diff. (a.u.)</span><span class="se">\n</span><span class="s1">(second &amp; last</span><span class="se">\n</span><span class="s1">peaks)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ToF (s)</span><span class="se">\n</span><span class="s1">(second peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ToF (s)</span><span class="se">\n</span><span class="s1">(last peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ToF Diff. (s)</span><span class="se">\n</span><span class="s1">(second &amp; last</span><span class="se">\n</span><span class="s1">peaks)&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">relative_peaks</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">peak_2_tof_row</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">peak_last_tof_row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">y_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;Ampl. (a.u.)</span><span class="se">\n</span><span class="s1">(second peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Ampl. (a.u.)</span><span class="se">\n</span><span class="s1">(last peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ToF (s)</span><span class="se">\n</span><span class="s1">(second peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ToF (s)</span><span class="se">\n</span><span class="s1">(last peak)&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Time-domain peaks. </span><span class="si">{}</span><span class="se">\n</span><span class="s1">Second and last acoustic peaks.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rate_for_title</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">domain</span><span class="o">==</span><span class="s1">&#39;freq&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">freq_ind_pair</span> <span class="o">!=</span> <span class="p">():</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">y_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;FFT magn. (a.u. x1000)</span><span class="se">\n</span><span class="s1">(</span><span class="si">{:.2f}</span><span class="s1"> MHz)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">freqs_1d</span><span class="p">[</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                <span class="s1">&#39;FFT magn. (a.u.x1000)</span><span class="se">\n</span><span class="s1">(</span><span class="si">{:.2f}</span><span class="s1"> MHz)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">freqs_1d</span><span class="p">[</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                <span class="s1">&#39;FFT magn. Diff between</span><span class="se">\n</span><span class="s1">selected freq. components&#39;</span>
            <span class="p">]</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Freq-domain. </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rate_for_title</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">c_rate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_rates</span><span class="p">):</span>
        <span class="n">filter1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">][</span><span class="s1">&#39;C-Rate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c_rate</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filter1</span><span class="p">,</span> <span class="s1">&#39;Cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">c_rate</span> <span class="o">==</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">col_scheme</span> <span class="o">=</span> <span class="s1">&#39;Greens&#39;</span>
        <span class="k">elif</span> <span class="n">c_rate</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">col_scheme</span> <span class="o">=</span> <span class="s1">&#39;Reds&#39;</span>
        <span class="k">elif</span> <span class="n">c_rate</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">col_scheme</span> <span class="o">=</span> <span class="s1">&#39;Blues&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)):</span>
            <span class="n">cell_id</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">filter2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">][</span><span class="s1">&#39;Cell_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_id</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colorscheme</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">),</span> <span class="n">col_scheme</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">cycles</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">cycle</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># To display cycles starting at 1 instead of 0</span>
                <span class="n">filter3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">][</span><span class="s1">&#39;Cycle&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cycle</span>
                <span class="nb">filter</span> <span class="o">=</span> <span class="n">filter1</span> <span class="o">&amp;</span> <span class="n">filter2</span> <span class="o">&amp;</span> <span class="n">filter3</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="n">x_quantity</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="c1"># For each C rate use a separate axs to produce labels.</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;V(V)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;V(V)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;V(V)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;V(V)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>             
                <span class="k">if</span> <span class="n">domain</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">relative_peaks</span><span class="p">:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">-</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_tofs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">-</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_tofs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">peak_2_tof_row</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_tofs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">peak_last_tof_row</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_tofs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">domain</span> <span class="o">==</span> <span class="s1">&#39;freq&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">freq_ind_pair</span> <span class="o">!=</span> <span class="p">():</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">-</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">handle_linewidth</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlines</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="c1"># Adjust the linewidth of the legend lines</span>
            <span class="n">custom_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="n">handle</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">handle_linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span> <span class="o">=</span> <span class="n">custom_handles</span><span class="p">,</span> 
                <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cycle (</span><span class="si">{}</span><span class="s2">C)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rate</span><span class="p">),</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="c1"># Adjust the linewidth of the legend lines</span>
            <span class="n">custom_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="n">handle</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">handle_linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span> <span class="o">=</span> <span class="n">custom_handles</span><span class="p">,</span> 
                <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cycle (</span><span class="si">{}</span><span class="s2">C)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rate</span><span class="p">),</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="c1"># Adjust the linewidth of the legend lines</span>
            <span class="n">custom_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="n">handle</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">handle_linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span> <span class="o">=</span> <span class="n">custom_handles</span><span class="p">,</span>
                <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cycle (</span><span class="si">{}</span><span class="s2">C)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rate</span><span class="p">),</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="s1">&#39;SoC&#39;</span> <span class="ow">in</span> <span class="n">x_quantity</span><span class="p">:</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="s1">&#39;SoC&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="n">x_quantity</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;V(V)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">axlabels_font_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rows</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">axlabels_font_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)):</span>
        <span class="n">cell_id</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">axlabels_font_size</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlims</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cell </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell_aliases</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">subtitle_font_size</span><span class="p">)</span>
    
    <span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">ticksize</span><span class="p">)</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">ticksize</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">align_ylabels</span><span class="p">(</span><span class="n">axs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="c1"># f.suptitle(title, fontsize=title_font_size)</span>
    <span class="k">if</span> <span class="n">save_filename</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">saveformat</span> <span class="o">==</span> <span class="s1">&#39;png&#39;</span><span class="p">:</span>
            <span class="n">save_filename</span> <span class="o">+=</span> <span class="s1">&#39;.png&#39;</span>
        <span class="k">elif</span> <span class="n">saveformat</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
            <span class="n">save_filename</span> <span class="o">+=</span> <span class="s1">&#39;.pdf&#39;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">visualisation_path</span><span class="p">,</span> <span class="n">save_filename</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">saveformat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_axes</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">axs</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_cycling_data">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.plot_cycling_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_cycling_data</span><span class="p">(</span><span class="n">df_cycling</span><span class="p">,</span> <span class="n">df_peak_tofs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">axs</span><span class="p">):</span>
    <span class="c1"># Plot Cycling data only</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s1">&#39;Cycle&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">999</span>
    <span class="n">unique_cycles</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;Cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">unique_cycles</span><span class="p">:</span>
        <span class="n">filter_cycle</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s1">&#39;Cycle&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">cycle</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filter_cycle</span><span class="p">]</span>
        <span class="n">time_h</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;Time(s)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_h</span><span class="p">,</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;C-Rate&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_h</span><span class="p">,</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;V(V)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_h</span><span class="p">,</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;Temp(degC)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_h</span><span class="p">,</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;Q(mAh)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
        <span class="n">filter_pol</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s1">&#39;Polarisation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filter_pol</span><span class="p">,</span> <span class="s1">&#39;Q(mAh)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
                    <span class="o">-</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filter_pol</span><span class="p">,</span> <span class="s1">&#39;Q(mAh)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">capacity_time</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filter_pol</span><span class="p">,</span> <span class="s1">&#39;Time(s)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3600</span>
        <span class="c1"># Capacity_datetime = temp_df.loc[filter, &#39;Datetime&#39;].iloc[-1]</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">capacity_time</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
        <span class="c1"># Back wall echo peak</span>
        <span class="n">echo_peak</span> <span class="o">=</span> <span class="n">df_peak_tofs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filter_cycle</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_h</span><span class="p">,</span> <span class="n">echo_peak</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>

    <span class="c1"># Draw a line at Q=0</span>
    <span class="n">xlims</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlims</span><span class="p">)</span>
    <span class="c1"># Define consistent y limits for the Temperature, Q and capacity axes</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">27</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">18</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">245</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">245</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">235</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">125</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">235</span><span class="p">])</span>
    <span class="c1">#</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;C-rate&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;V</span><span class="se">\n</span><span class="s1">(V)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Temp</span><span class="se">\n</span><span class="s1">($^\circ$C)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Q</span><span class="se">\n</span><span class="s1">(mAh)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Capacity</span><span class="se">\n</span><span class="s1">(mAh)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Back wall</span><span class="se">\n</span><span class="s1">echo peak</span><span class="se">\n</span><span class="s1">ToF (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;C/5&#39;</span><span class="p">,</span> <span class="s1">&#39;C/2&#39;</span><span class="p">,</span> <span class="s1">&#39;1C&#39;</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (h)&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">align_ylabels</span><span class="p">()</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">SonicBatt</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/SonicBatt.utils.html">SonicBatt.utils</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Elias Galiounas.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>