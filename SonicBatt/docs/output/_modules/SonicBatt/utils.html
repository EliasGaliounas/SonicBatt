<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SonicBatt.utils &#8212; SonicBatt 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for SonicBatt.utils</h1><div class="highlight"><pre>
<span></span><span class="c1">#Classes-----------------------------------------------</span>
<span class="c1">#------------------------------------------------------</span>
<div class="viewcode-block" id="Pulse">
<a class="viewcode-back" href="../../index.html#SonicBatt.utils.Pulse">[docs]</a>
<span class="k">class</span> <span class="nc">Pulse</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Contains information for single pulses.</span>
<span class="sd">        &quot;C&quot; indicates a step where current is not zero.</span>
<span class="sd">        &quot;R&quot; indicates a rest step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Index labelling:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Temperature info:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_stdev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_temp_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_temp_stdev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_temp_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_temp_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># OCV &amp; mAh info:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_OCV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_mAh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_end_OCV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_end_mAh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Resistance info:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_R0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_R0_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_R0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_R0_dt</span> <span class="o">=</span> <span class="kc">None</span></div>


<span class="k">class</span> <span class="nc">PulseSequence</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1">#Pulse_list will be a list of Pulse objects    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pulse_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Acoustic_Pulse</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Contains information for single pulses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Index labelling:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_pre_start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_pre_end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Temperature info:</span>
        <span class="c1"># During pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_stdev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_temp_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_end_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Relaxation post pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_temp_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_temp_stdev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_temp_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_temp_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_start_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_end_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Relaxation pre pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_pre_temp_mean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># OCV &amp; mAh info:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_pre_end_OCV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_pre_end_mAh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_OCV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_start_mAh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_end_OCV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_post_end_mAh</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">Acoustic_PulseSequence</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1">#Pulse_list will be a list of Pulse objects    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Acoustic_Pulse_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">OCV_fit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;type&quot; will be either &quot;pre_eis&quot; or &quot;post_eis&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relax_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OCV_fitted</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RC_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tau1&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;tau2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;x3&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">EIS_object</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eis_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eis_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eis_start_datetime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_ind</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Latest index from df_cycling</span>
        <span class="c1"># For studies doing EIS repetitions:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_step</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">EIS_sequence</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EIS_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">Acoustic_p2C</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_ind_list</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">Protocol_custom_objects</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cell_Q</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">P_char_chrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">P_char_dischrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">EIS_char_chrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">EIS_char_dischrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">EIS_other_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Acoustic_char_chrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Acoustic_char_dischrg_seq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">test_id</span> <span class="o">=</span> <span class="n">test_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_Q</span> <span class="o">=</span> <span class="n">cell_Q</span>
        <span class="c1">#Computations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_char_chrg_seq</span> <span class="o">=</span> <span class="n">P_char_chrg_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P_char_dischrg_seq</span> <span class="o">=</span> <span class="n">P_char_dischrg_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EIS_char_chrg_seq</span> <span class="o">=</span> <span class="n">EIS_char_chrg_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EIS_char_dischrg_seq</span> <span class="o">=</span> <span class="n">EIS_char_dischrg_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EIS_other_seq</span> <span class="o">=</span> <span class="n">EIS_other_seq</span> <span class="c1">#For drive cycle prep protocols which contain one or more EIS experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Acoustic_char_chrg_seq</span> <span class="o">=</span> <span class="n">Acoustic_char_chrg_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Acoustic_char_dischrg_seq</span> <span class="o">=</span> <span class="n">Acoustic_char_dischrg_seq</span>

<span class="c1">#ECM fitting functionality-----------------------------</span>
<span class="c1">#------------------------------------------------------</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">least_squares</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">exp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">relax_2RC</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    x = [&#39;OCV&#39;, &#39;tau1&#39;, &#39;tau2&#39;, &#39;init_RC1_vs_R2_weight&#39;]</span>
<span class="sd">    u = [&#39;Vt_start&#39;, &#39;time_vector&#39;]</span>
<span class="sd">    # Note that R0 is not provided or calculated</span>
<span class="sd">    # When fitting data the R0 part of the relaxation should be omitted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Time</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">Time</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">Vt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">V12_prev</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">V1_prev</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">V12_prev</span>
    <span class="n">V2_prev</span> <span class="o">=</span> <span class="n">V12_prev</span> <span class="o">-</span> <span class="n">V1_prev</span>
    <span class="c1">#</span>
    <span class="n">delta_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Time</span><span class="p">)</span>
    <span class="n">A1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">delta_ts</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">A2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">delta_ts</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Time</span><span class="p">)):</span>
        <span class="c1"># delta_t = Time[t]- Time[t-1]</span>
        <span class="c1"># A1 = exp(-delta_t/x[1])</span>
        <span class="c1"># A2 = exp(-delta_t/x[2])</span>
        <span class="n">A1</span> <span class="o">=</span> <span class="n">A1s</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">A2</span> <span class="o">=</span> <span class="n">A2s</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">V1_new</span> <span class="o">=</span> <span class="n">V1_prev</span><span class="o">*</span><span class="n">A1</span>
        <span class="n">V2_new</span> <span class="o">=</span> <span class="n">V2_prev</span><span class="o">*</span><span class="n">A2</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">V1_new</span> <span class="o">+</span> <span class="n">V2_new</span>
        <span class="n">V1_prev</span> <span class="o">=</span> <span class="n">V1_new</span>
        <span class="n">V2_prev</span> <span class="o">=</span> <span class="n">V2_new</span>
        <span class="n">Vt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc</span>
    <span class="k">return</span> <span class="n">Vt</span>

<span class="k">def</span> <span class="nf">error_relax_2RC</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">tail_heavy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    x = [&#39;OCV&#39;, &#39;tau1&#39;, &#39;tau2&#39;, &#39;init_RC1_vs_R2_weight&#39;]</span>
<span class="sd">    u = [&#39;Vt_start&#39;, &#39;time_vector&#39;]</span>
<span class="sd">    y = True Output (Vt)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">relax_2RC</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span>
    <span class="k">if</span> <span class="n">tail_heavy</span><span class="p">:</span>
        <span class="n">error</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">):]</span> <span class="o">*=</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="n">error</span>

<span class="k">def</span> <span class="nf">eval_plot_relax_2RC</span><span class="p">(</span><span class="n">Vt</span><span class="p">,</span> <span class="n">time_vector</span><span class="p">,</span> <span class="n">tail_heavy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">make_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    x = [&#39;OCV&#39;, &#39;tau1&#39;, &#39;tau2&#39;, &#39;init_RC1_vs_RC2_weight&#39;]</span>
<span class="sd">    u = [&#39;Vt_start&#39;, &#39;time_vector&#39;]   </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">OCV_guess</span> <span class="o">=</span> <span class="n">Vt</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">tau1_guess</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">tau2_guess</span> <span class="o">=</span> <span class="mi">3000</span>
    <span class="n">init_RC1_vs_R2_weight_guess</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="p">[</span><span class="n">OCV_guess</span><span class="p">,</span> <span class="n">tau1_guess</span><span class="p">,</span> <span class="n">tau2_guess</span><span class="p">,</span> <span class="n">init_RC1_vs_R2_weight_guess</span><span class="p">]</span>
    <span class="n">Vt_start</span> <span class="o">=</span> <span class="n">Vt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">OCV_guess</span><span class="o">&gt;</span><span class="n">Vt_start</span><span class="p">:</span>
        <span class="n">lb_OCV</span> <span class="o">=</span> <span class="n">OCV_guess</span><span class="o">*</span><span class="mf">0.9</span> <span class="c1"># For voltage was 1</span>
        <span class="n">ub_OCV</span> <span class="o">=</span> <span class="n">OCV_guess</span><span class="o">*</span><span class="mf">1.1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lb_OCV</span> <span class="o">=</span> <span class="n">OCV_guess</span><span class="o">*</span><span class="mf">0.9</span>
        <span class="n">ub_OCV</span> <span class="o">=</span> <span class="n">OCV_guess</span><span class="o">*</span><span class="mf">1.1</span> <span class="c1"># For voltage was 1</span>
    <span class="n">lb_tau1</span><span class="p">,</span> <span class="n">ub_tau1</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">500</span>
    <span class="n">lb_tau2</span><span class="p">,</span> <span class="n">ub_tau2</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">5000</span>
    <span class="n">lb_x3</span><span class="p">,</span> <span class="n">ub_x3</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="n">lb_OCV</span><span class="p">,</span> <span class="n">lb_tau1</span><span class="p">,</span> <span class="n">lb_tau2</span><span class="p">,</span> <span class="n">lb_x3</span><span class="p">],</span>
        <span class="p">[</span><span class="n">ub_OCV</span><span class="p">,</span> <span class="n">ub_tau1</span><span class="p">,</span> <span class="n">ub_tau2</span><span class="p">,</span> <span class="n">ub_x3</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="c1"># u = [Vt_start, time_vector]</span>
    <span class="n">u</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vt_start</span><span class="p">,</span> <span class="n">time_vector</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="n">error_relax_2RC</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">Vt</span><span class="p">,</span> <span class="n">tail_heavy</span><span class="p">),</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#, max_nfev = 1000</span>
    <span class="n">time_vector_plot</span> <span class="o">=</span> <span class="n">time_vector</span> <span class="o">-</span> <span class="n">time_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;OCV&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;tau1&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;tau2&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;init_RC1_vs_RC2_weight&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]}</span>
    <span class="k">if</span> <span class="n">make_plot</span><span class="p">:</span>
        <span class="n">Vt_calc</span> <span class="o">=</span> <span class="n">relax_2RC</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_vector_plot</span><span class="p">,</span> <span class="n">Vt</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_vector_plot</span><span class="p">,</span> <span class="n">Vt_calc</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;2 RC pairs&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;2 RC pairs&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Params</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">Params</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pulse_2RC</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    if R0 is to be fitted, it will be included in x and not in u:</span>
<span class="sd">        x = [tau1, tau2, R1, R2, R0]</span>
<span class="sd">        u = [SoC_start, Vt_start, time_vector, </span>
<span class="sd">            current_vector, Qmax, SoC_OCV_mapping]</span>
<span class="sd">    else:</span>
<span class="sd">        x = [tau1, tau2, R1, R2]</span>
<span class="sd">        u = [SoC_start, Vt_start, time_vector, </span>
<span class="sd">        current_vector, Qmax, SoC_OCV_mapping, R0]</span>
<span class="sd">    ** SoC_OCV_mapping is a structured ndarray (it has &#39;SoC&#39; and &#39;OCV&#39; entries)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Time</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">It</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="c1"># SoC = u[0]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">):</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">):</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You must provide R0 either in x or u&#39;</span><span class="p">)</span>
    <span class="n">delta_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Time</span><span class="p">)</span>
    <span class="n">dSoCs</span> <span class="o">=</span> <span class="p">(</span><span class="n">It</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">delta_ts</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1000</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">u</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> 
    <span class="n">SoCs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dSoCs</span><span class="p">)</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">OCVs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span> <span class="n">SoCs</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="s1">&#39;SoC&#39;</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="s1">&#39;OCV&#39;</span><span class="p">])</span>
    <span class="n">A1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">delta_ts</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">A2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">delta_ts</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">V1_prev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">V2_prev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">It</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">Vt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Time</span><span class="p">)):</span>
    <span class="c1"># for t in range(len(delta_ts)):</span>
        <span class="c1"># delta_t = Time[t] - Time[t-1]</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">It</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="c1"># delta_mAh = (I * delta_t)*(1000/3600)</span>
        <span class="c1"># SoC +=  delta_mAh / u[4] *100</span>
        <span class="c1"># OCV = np.interp( SoC, u[5][&#39;SoC&#39;], u[5][&#39;OCV&#39;])############</span>
        <span class="c1"># A1 = exp( -delta_t/x[0] )</span>
        <span class="c1"># A2 = exp( -delta_t/x[1] )</span>
        <span class="c1"># delta_t = delta_ts[t]</span>
        <span class="c1"># I = It[t+1]</span>
        <span class="n">OCV</span> <span class="o">=</span> <span class="n">OCVs</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">A1</span> <span class="o">=</span> <span class="n">A1s</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">A2</span> <span class="o">=</span> <span class="n">A2s</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">V1_new</span> <span class="o">=</span> <span class="n">V1_prev</span><span class="o">*</span><span class="n">A1</span> <span class="o">+</span> <span class="n">I</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">A1</span><span class="p">)</span>
        <span class="n">V2_new</span> <span class="o">=</span> <span class="n">V2_prev</span><span class="o">*</span><span class="n">A2</span> <span class="o">+</span> <span class="n">I</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">A2</span><span class="p">)</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">OCV</span> <span class="o">+</span> <span class="n">R0</span><span class="o">*</span><span class="n">I</span> <span class="o">+</span> <span class="n">V1_new</span> <span class="o">+</span> <span class="n">V2_new</span>
        <span class="n">V1_prev</span> <span class="o">=</span> <span class="n">V1_new</span>
        <span class="n">V2_prev</span> <span class="o">=</span> <span class="n">V2_new</span>
        <span class="n">Vt</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc</span>
        <span class="c1"># Vt[t+1] = calc</span>
    <span class="k">return</span> <span class="n">Vt</span>

<span class="k">def</span> <span class="nf">error_pulse_2RC</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">tail_heavy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    if R0 is to be fitted, it will be included in x and not in u:</span>
<span class="sd">        x = [tau1, tau2, R1, R2, R0]</span>
<span class="sd">        u = [SoC_start, Vt_start, time_vector, </span>
<span class="sd">            current_vector, Qmax, SoC_OCV_mapping]</span>
<span class="sd">    else:</span>
<span class="sd">        x = [tau1, tau2, R1, R2]</span>
<span class="sd">        u = [SoC_start, Vt_start, time_vector, </span>
<span class="sd">        current_vector, Qmax, SoC_OCV_mapping, R0]</span>
<span class="sd">    ** SoC_OCV_mapping is a structured ndarray (it has &#39;SoC&#39; and &#39;OCV&#39; entries)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">pulse_2RC</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span>
    <span class="k">if</span> <span class="n">tail_heavy</span><span class="p">:</span>
        <span class="n">error</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">):]</span> <span class="o">*=</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="n">error</span>

<span class="k">def</span> <span class="nf">eval_plot_pulse_2RC</span><span class="p">(</span><span class="n">Vt</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tail_heavy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">make_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    if R0 is to be fitted, it will be included in x and not in u:</span>
<span class="sd">        x = [tau1, tau2, R1, R2, R0]</span>
<span class="sd">        u = [SoC_start, Vt_start, time_vector, </span>
<span class="sd">            current_vector, Qmax, SoC_OCV_mapping]</span>
<span class="sd">    else:</span>
<span class="sd">        x = [tau1, tau2, R1, R2]</span>
<span class="sd">        u = [SoC_start, Vt_start, time_vector, </span>
<span class="sd">        current_vector, Qmax, SoC_OCV_mapping, R0]</span>
<span class="sd">    ** SoC_OCV_mapping is a structured ndarray (it has &#39;SoC&#39; and &#39;OCV&#39; entries)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># tau1_guess = x0[0]</span>
    <span class="c1"># tau2_guess = x0[1]</span>
    <span class="c1"># R1_guess = 5</span>
    <span class="c1"># R2_guess = 0.005</span>
    <span class="n">lb_tau1</span><span class="p">,</span> <span class="n">ub_tau1</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">500</span>
    <span class="n">lb_tau2</span><span class="p">,</span> <span class="n">ub_tau2</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">5000</span>
    <span class="c1"># lb_R1, ub_R1 = 0.00001, np.inf</span>
    <span class="c1"># lb_R2, ub_R2 = 0.00001, np.Inf</span>
    <span class="n">lb_R1</span><span class="p">,</span> <span class="n">ub_R1</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">lb_R2</span><span class="p">,</span> <span class="n">ub_R2</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">lb_tau1</span><span class="p">,</span> <span class="n">lb_tau2</span><span class="p">,</span> <span class="n">lb_R1</span><span class="p">,</span> <span class="n">lb_R2</span><span class="p">],</span>
            <span class="p">[</span><span class="n">ub_tau1</span><span class="p">,</span> <span class="n">ub_tau2</span><span class="p">,</span> <span class="n">ub_R1</span><span class="p">,</span> <span class="n">ub_R2</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">lb_tau1</span><span class="p">,</span> <span class="n">lb_tau2</span><span class="p">,</span> <span class="n">lb_R1</span><span class="p">,</span> <span class="n">lb_R2</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">],</span>
            <span class="p">[</span><span class="n">ub_tau1</span><span class="p">,</span> <span class="n">ub_tau2</span><span class="p">,</span> <span class="n">ub_R1</span><span class="p">,</span> <span class="n">ub_R2</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">]</span>
            <span class="p">)</span>        
    <span class="n">res</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="n">error_pulse_2RC</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">Vt</span><span class="p">,</span> <span class="n">tail_heavy</span><span class="p">),</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#, max_nfev = 1000</span>
    <span class="n">time_vector_plot</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">Params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tau1&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;tau2&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;R1&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]}</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">Params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tau1&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;tau2&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;R1&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;R0&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too many or too few estimated parameters&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">make_plot</span><span class="p">:</span>
        <span class="n">Vt_calc</span> <span class="o">=</span> <span class="n">pulse_2RC</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_vector_plot</span><span class="p">,</span> <span class="n">Vt</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_vector_plot</span><span class="p">,</span> <span class="n">Vt_calc</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;2 RC pairs&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;2 RC pairs&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Params</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">Params</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">time_vector</span><span class="p">,</span> <span class="n">Vt_start</span><span class="p">,</span> <span class="n">SoC_start</span><span class="p">,</span> <span class="n">Capacity</span><span class="p">,</span> <span class="n">SoC_OCV_mapping</span><span class="p">,</span>
    <span class="n">RC_params_chrg</span><span class="p">,</span> <span class="n">RC_params_dischrg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    RC_params is a structured ndarray with entries:</span>
<span class="sd">    &#39;SoC&#39;, &#39;R0&#39;, &#39;tau1&#39;, &#39;tau2&#39;, &#39;R1&#39;, &#39;R2&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Time</span> <span class="o">=</span> <span class="n">time_vector</span>
    <span class="n">SoC</span> <span class="o">=</span> <span class="n">SoC_start</span>
    <span class="n">V1_prev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">V2_prev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">It</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">Vt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vt_start</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">It</span><span class="p">)):</span>
        <span class="n">delta_t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">Time</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">It</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">delta_mAh</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span> <span class="o">*</span> <span class="n">delta_t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1000</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span>
        <span class="n">SoC</span> <span class="o">+=</span>  <span class="n">delta_mAh</span> <span class="o">/</span> <span class="n">Capacity</span> <span class="o">*</span><span class="mi">100</span>
        <span class="c1">#Interpolate the model parameters to this SoC</span>
        <span class="k">if</span> <span class="n">I</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">RC_params</span> <span class="o">=</span> <span class="n">RC_params_chrg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">RC_params</span> <span class="o">=</span> <span class="n">RC_params_dischrg</span>
        <span class="n">OCV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">SoC</span><span class="p">,</span> <span class="n">SoC_OCV_mapping</span><span class="p">[</span><span class="s1">&#39;SoC&#39;</span><span class="p">],</span> <span class="n">SoC_OCV_mapping</span><span class="p">[</span><span class="s1">&#39;OCV&#39;</span><span class="p">])</span>
        <span class="c1"># SoC = np.interp(SoC, RC_params[&#39;SoC&#39;], RC_params[&#39;SoC&#39;])</span>
        <span class="n">R0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">SoC</span><span class="p">,</span> <span class="n">RC_params</span><span class="p">[</span><span class="s1">&#39;SoC&#39;</span><span class="p">],</span> <span class="n">RC_params</span><span class="p">[</span><span class="s1">&#39;R0&#39;</span><span class="p">])</span>
        <span class="n">tau1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">SoC</span><span class="p">,</span> <span class="n">RC_params</span><span class="p">[</span><span class="s1">&#39;SoC&#39;</span><span class="p">],</span> <span class="n">RC_params</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">])</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">SoC</span><span class="p">,</span> <span class="n">RC_params</span><span class="p">[</span><span class="s1">&#39;SoC&#39;</span><span class="p">],</span> <span class="n">RC_params</span><span class="p">[</span><span class="s1">&#39;tau2&#39;</span><span class="p">])</span>
        <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">SoC</span><span class="p">,</span> <span class="n">RC_params</span><span class="p">[</span><span class="s1">&#39;SoC&#39;</span><span class="p">],</span> <span class="n">RC_params</span><span class="p">[</span><span class="s1">&#39;R1&#39;</span><span class="p">])</span>
        <span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">SoC</span><span class="p">,</span> <span class="n">RC_params</span><span class="p">[</span><span class="s1">&#39;SoC&#39;</span><span class="p">],</span> <span class="n">RC_params</span><span class="p">[</span><span class="s1">&#39;R2&#39;</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="n">A1</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">delta_t</span><span class="o">/</span><span class="n">tau1</span><span class="p">)</span>
        <span class="n">A2</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">delta_t</span><span class="o">/</span><span class="n">tau2</span><span class="p">)</span>
        <span class="n">V1_new</span> <span class="o">=</span> <span class="n">V1_prev</span><span class="o">*</span><span class="n">A1</span> <span class="o">+</span> <span class="n">I</span><span class="o">*</span><span class="n">R1</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">A1</span><span class="p">)</span>
        <span class="n">V2_new</span> <span class="o">=</span> <span class="n">V2_prev</span><span class="o">*</span><span class="n">A2</span> <span class="o">+</span> <span class="n">I</span><span class="o">*</span><span class="n">R2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">A2</span><span class="p">)</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">OCV</span> <span class="o">+</span> <span class="n">R0</span><span class="o">*</span><span class="n">I</span> <span class="o">+</span> <span class="n">V1_new</span> <span class="o">+</span> <span class="n">V2_new</span>
        <span class="n">V1_prev</span> <span class="o">=</span> <span class="n">V1_new</span>
        <span class="n">V2_prev</span> <span class="o">=</span> <span class="n">V2_new</span>        
        <span class="n">Vt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc</span>
    <span class="k">return</span> <span class="n">Vt</span>

<span class="c1">#Colormap plotting-------------------------------------</span>
<span class="c1">#------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="k">def</span> <span class="nf">calc_lims</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates plot limits for the input data with reasonable rounding.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span><span class="p">,</span> <span class="n">floor</span><span class="p">,</span> <span class="n">log10</span>
    <span class="n">lim1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">lim2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">floor</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">lim2</span><span class="o">-</span><span class="n">lim1</span><span class="p">))</span>
    <span class="n">lim1</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">lim1</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
    <span class="n">lim2</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">lim2</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
    <span class="n">lims</span> <span class="o">=</span> <span class="p">(</span> <span class="n">lim1</span><span class="p">,</span> <span class="n">lim2</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">lims</span>

<span class="k">def</span> <span class="nf">ax_colormap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">crops</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">xlims</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">ylims</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cmap_title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
        <span class="n">shading</span> <span class="o">=</span> <span class="s1">&#39;gouraud&#39;</span><span class="p">,</span> <span class="n">cmap_lims</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    x: 1D vector of the x-axis values</span>
<span class="sd">    y: 1D vector of the y-axis values</span>
<span class="sd">    C: 2D array containing the quantity that will define the colour for each x-y point.</span>
<span class="sd">    cmap: can vary, e.g. &#39;viridis&#39;, &#39;seismic&#39;, &#39;PiYG&#39;</span>
<span class="sd">    norm: can be equal to &#39;norm&#39;, &#39;diverging&#39; or &#39;log&#39;</span>
<span class="sd">    crops: [crop_x1, crop_x2, crop_y1, crop_y2]. if crops[1] or crops[3] are left at their default</span>
<span class="sd">        values of -1 then they will automatically be set so that there is no crop.</span>
<span class="sd">    xlims / ylims: If left at defaults (-1, -1) then they will be calculated with rounding</span>
<span class="sd">        to the relevant order of magnitude so that there are axes ticks both before and after data begins.</span>
<span class="sd">        If any other value is given, that limit will be as in the raw data.</span>
<span class="sd">    cmap_lims: if left at defaults [-1,-1] then the color bar limits will be calculated automatically.</span>
<span class="sd">        otherwise they will be as per user input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Import needed packages</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
    <span class="c1">#Define data crops</span>
    <span class="n">crop_x1</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">crop_y1</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">crops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">crop_x2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">crop_x2</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">crops</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">crop_y2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">crop_y2</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="c1">#Create 2D matrices for heatmap</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">:</span><span class="n">crop_x2</span><span class="p">],</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">crop_y1</span><span class="p">:</span><span class="n">crop_y2</span><span class="p">]),</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span> <span class="n">y</span><span class="p">[</span><span class="n">crop_y1</span><span class="p">:</span><span class="n">crop_y2</span><span class="p">],</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">:</span><span class="n">crop_x2</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">:</span><span class="n">crop_x2</span><span class="p">,</span> <span class="n">crop_y1</span><span class="p">:</span><span class="n">crop_y2</span><span class="p">]</span>
    <span class="c1">#Define the Colormap Normalization</span>
    <span class="k">if</span> <span class="n">cmap_lims</span> <span class="o">!=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1">#i.e. if colourmap limits have been defined</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">cmap_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">cmap_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vcenter</span> <span class="o">=</span> <span class="p">(</span><span class="n">vmin</span><span class="o">+</span><span class="n">vmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">vcenter</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;norm&#39;</span><span class="p">:</span>
        <span class="n">C_norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span> <span class="p">(</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">C_norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span> <span class="p">(</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;diverging&#39;</span><span class="p">:</span>
        <span class="n">C_norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">DivergingNorm</span> <span class="p">(</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vcenter</span><span class="o">=</span><span class="n">vcenter</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Define a correct Colormap Normalization Method&quot;</span><span class="p">)</span>
    <span class="c1">#Create Axes</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="n">shading</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">C_norm</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cmap_title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="c1">#Define and set the axis limits</span>
    <span class="k">if</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">lims</span> <span class="o">=</span> <span class="n">calc_lims</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">:</span><span class="n">crop_x2</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">xlims</span> <span class="o">=</span> <span class="n">lims</span>
        <span class="k">elif</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">xlims</span> <span class="o">=</span> <span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">crop_x2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xlims</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xlims</span> <span class="o">=</span> <span class="p">(</span> <span class="n">x</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">crop_x2</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">lims</span> <span class="o">=</span> <span class="n">calc_lims</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">crop_y1</span><span class="p">:</span><span class="n">crop_y2</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">ylims</span> <span class="o">=</span> <span class="n">lims</span>
        <span class="k">elif</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ylims</span> <span class="o">=</span> <span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">crop_y2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ylims</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">crop_y1</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylims</span> <span class="o">=</span> <span class="p">(</span> <span class="n">y</span><span class="p">[</span><span class="n">crop_y1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">crop_y2</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlims</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylims</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">map</span>

<span class="k">def</span> <span class="nf">plot_colormap</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">crops</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">xlims</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">ylims</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cmap_title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
        <span class="n">shading</span> <span class="o">=</span> <span class="s1">&#39;gouraud&#39;</span><span class="p">,</span> <span class="n">cmap_lims</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cbar_label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
        <span class="n">cbar_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        x: 1D vector of the x-axis values</span>
<span class="sd">        y: 1D vector of the y-axis values</span>
<span class="sd">        C: 2D array containing the quantity that will define the colour for each x-y point.</span>
<span class="sd">        cmap: can vary, e.g. &#39;viridis&#39;, &#39;seismic&#39;, &#39;PiYG&#39;</span>
<span class="sd">        norm: can be equal to &#39;norm&#39;, &#39;diverging&#39; or &#39;log&#39;</span>
<span class="sd">        crops: [crop_x1, crop_x2, crop_y1, crop_y2]. if crops[1] or crops[3] are left at their default</span>
<span class="sd">            values of -1 then they will automatically be set so that there is no crop.</span>
<span class="sd">        xlims / ylims: If left at defaults (-1, -1) then they will be calculated with rounding</span>
<span class="sd">            to the relevant order of magnitude so that there are axes ticks both before and after data begins.</span>
<span class="sd">            If any other value is given, that limit will be as in the raw data.</span>
<span class="sd">        cmap_lims: if left at defaults [-1,-1] then the color bar limits will be calculated automatically.</span>
<span class="sd">            otherwise they will be as per user input.</span>
<span class="sd">        cbar_ticks: list of ticks for the colourbar. Default list of [-1] means default ticks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">ax_colormap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">,</span> <span class="n">crops</span> <span class="o">=</span> <span class="n">crops</span><span class="p">,</span>
        <span class="n">xlims</span> <span class="o">=</span> <span class="n">xlims</span><span class="p">,</span> <span class="n">ylims</span> <span class="o">=</span> <span class="n">ylims</span><span class="p">,</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel</span><span class="p">,</span> 
        <span class="n">cmap_title</span> <span class="o">=</span> <span class="n">cmap_title</span><span class="p">,</span> <span class="n">shading</span> <span class="o">=</span> <span class="n">shading</span><span class="p">,</span> <span class="n">cmap_lims</span> <span class="o">=</span> <span class="n">cmap_lims</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cbar_ticks</span> <span class="o">==</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">cbar_label</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">cbar_label</span><span class="p">,</span>
            <span class="n">ticks</span><span class="o">=</span><span class="n">cbar_ticks</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">dir</span><span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">filename</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>

<span class="k">def</span> <span class="nf">sub_colormap_V_SOC_T</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">y4</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">crops</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">xlims</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">y1lims</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">y2lims</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">y3lims</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">y4lims</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cmap_title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">shading</span> <span class="o">=</span> <span class="s1">&#39;gouraud&#39;</span><span class="p">,</span> <span class="n">cmap_lims</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
        <span class="n">cbar_label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cbar_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dpi</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">ax_colormap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">,</span> <span class="n">crops</span> <span class="o">=</span> <span class="n">crops</span><span class="p">,</span>
        <span class="n">xlims</span> <span class="o">=</span> <span class="n">xlims</span><span class="p">,</span> <span class="n">ylims</span> <span class="o">=</span> <span class="n">y1lims</span><span class="p">,</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel</span><span class="p">,</span> 
        <span class="n">cmap_title</span> <span class="o">=</span> <span class="n">cmap_title</span><span class="p">,</span> <span class="n">shading</span> <span class="o">=</span> <span class="n">shading</span><span class="p">,</span> <span class="n">cmap_lims</span> <span class="o">=</span> <span class="n">cmap_lims</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">cbar_ticks</span> <span class="o">==</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">cbar_label</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">cbar_label</span><span class="p">,</span>
            <span class="n">ticks</span><span class="o">=</span><span class="n">cbar_ticks</span><span class="p">)</span>
    <span class="n">crop_x1</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">crops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">crop_x2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">crop_x2</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">:</span><span class="n">crop_x2</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">:</span><span class="n">crop_x2</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">:</span><span class="n">crop_x2</span><span class="p">],</span> <span class="n">y3</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">:</span><span class="n">crop_x2</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">:</span><span class="n">crop_x2</span><span class="p">],</span> <span class="n">y4</span><span class="p">[</span><span class="n">crop_x1</span><span class="p">:</span><span class="n">crop_x2</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;SOC&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;T (C)&quot;</span><span class="p">)</span>

    <span class="c1">#Limits for axes 2, 3 and 4:</span>
    <span class="k">if</span> <span class="n">y2lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">y2lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">lims</span> <span class="o">=</span> <span class="n">calc_lims</span> <span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">y2lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y2lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">y2lims</span> <span class="o">=</span> <span class="n">lims</span>
        <span class="k">elif</span> <span class="n">y2lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">y2lims</span> <span class="o">=</span> <span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y2lims</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">y3lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">y3lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">lims</span> <span class="o">=</span> <span class="n">calc_lims</span> <span class="p">(</span><span class="n">y3</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">y3lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y3lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">y3lims</span> <span class="o">=</span> <span class="n">lims</span>
        <span class="k">elif</span> <span class="n">y3lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">y3lims</span> <span class="o">=</span> <span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y3</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y3lims</span> <span class="o">=</span> <span class="p">(</span><span class="n">y3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">y4lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">y4lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">lims</span> <span class="o">=</span> <span class="n">calc_lims</span> <span class="p">(</span><span class="n">y4</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">y4lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y4lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">y4lims</span> <span class="o">=</span> <span class="n">lims</span>
        <span class="k">elif</span> <span class="n">y4lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">y4lims</span> <span class="o">=</span> <span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y4</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y4lims</span> <span class="o">=</span> <span class="p">(</span><span class="n">y4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y2lims</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y3lims</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y4lims</span><span class="p">)</span>
    <span class="c1">#y ticks for axes 2, 3 and 4:</span>
    <span class="c1">#axs[1].set_yticks( [ y2lims[0]*0.99, y2lims[1]*1.01] )</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span> <span class="p">[</span> <span class="mf">2.75</span><span class="p">,</span> <span class="mf">4.2</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span> <span class="p">[</span> <span class="n">y3lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y3lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span> <span class="c1">#Don&#39;t scale this as it&#39;s the SOC.</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span> <span class="p">[</span> <span class="n">y4lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">y4lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1.01</span><span class="p">]</span> <span class="p">)</span>
    <span class="c1">#Format tick decimal points</span>
    <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FormatStrFormatter</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">dir</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">filename</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">axs</span>

<span class="c1">#Animate-----------------------------------------------</span>
<span class="c1">#------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="k">def</span> <span class="nf">animate_signals</span><span class="p">(</span><span class="n">df_cycling</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">fft_magns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">freqs_MHz</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">drc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">peak_heights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">peak_tofs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crop_ind</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">temp_lims</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">32</span><span class="p">),</span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mf">4.8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">annot_pos</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    https://jckantor.github.io/CBE30338/A.03-Animation-in-Jupyter-Notebooks.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Some data and exception handling</span>
    <span class="c1">#---------------------------------</span>
    <span class="k">if</span>  <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fft_magns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">freqs_MHz</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Provide_frequencies in MHz to accompany the fft_mangs input&#39;</span><span class="p">)</span>
    <span class="n">voltages</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s2">&quot;V(V)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">temperatures</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s2">&quot;Temp(degC)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">drc</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s2">&quot;C-Rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;CV&#39;</span> <span class="ow">in</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s1">&#39;Regime&#39;</span><span class="p">]:</span>
            <span class="n">cv_filter</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="p">[</span><span class="s1">&#39;Regime&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;CV&#39;</span>
            <span class="n">rates</span><span class="p">[</span><span class="n">cv_filter</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;CV&#39;</span>
        <span class="n">rate_cols</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">:</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;CV&#39;</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">}</span>
    <span class="n">anim_indices</span> <span class="o">=</span> <span class="n">df_cycling</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="kn">from</span> <span class="nn">SonicBatt.constants</span> <span class="kn">import</span> <span class="n">time_step</span>

    <span class="c1"># Create the background frame</span>
    <span class="c1">#----------------------------</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fft_magns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]},</span>
            <span class="n">constrained_layout</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annot_pos</span> <span class="o">==</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">annot_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fft_magns</span> <span class="o">/=</span> <span class="mi">1000</span> <span class="c1"># To make the axes plotting it look nicer.</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">4</span><span class="p">]},</span>
            <span class="n">constrained_layout</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
        <span class="n">line_freq_domain</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annot_pos</span> <span class="o">==</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">annot_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">crop_ind</span><span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">line1_time_domain</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
    <span class="n">line2_time_domain</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
    <span class="n">barV</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">barT</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">peak_heights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">n_peaks</span> <span class="o">=</span> <span class="n">peak_heights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">peaks_colorscheme</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">Greens</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_peaks</span><span class="p">))</span>
        <span class="n">scat_peaks</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_peaks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_peaks</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">peaks_colorscheme</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;tab:green&#39;</span><span class="p">)</span>   
    <span class="n">my_text</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">annot_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">annot_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">backgroundcolor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>    
    <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">18</span>
    <span class="c1"># axs[0] (line: time domain)</span>
    <span class="n">time_domain_value_range</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">signals</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">time_domain_value_range</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>       
        <span class="n">signals</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ToF (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Acoustic Intensity (a.u.)&#39;</span><span class="p">)</span>
    <span class="c1"># axs[1] (bar)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">4.4</span><span class="p">)</span>
    <span class="c1"># axs[2] (bar)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">temp_lims</span><span class="p">)</span>
    <span class="c1"># axs[3] (line: freq domain)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fft_magns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">freq_domain_value_range</span> <span class="o">=</span> <span class="n">fft_magns</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">fft_magns</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">freq_domain_value_range</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">fft_magns</span><span class="p">[</span><span class="n">anim_indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">fft_magns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.05</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">offset</span><span class="p">,</span> <span class="n">fft_magns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">freqs_MHz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freqs_MHz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;MHz&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;FFT magn. x 1000</span><span class="se">\n</span><span class="s1">(a.u.)&#39;</span><span class="p">)</span>
    <span class="c1"># General</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">title_font_size</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">align_ylabels</span><span class="p">()</span>

    <span class="c1"># TO help produce a progress update</span>
    <span class="n">progress_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">100.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="k">global</span> <span class="n">pct_progress</span>
    <span class="n">pct_progress</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># animation function. This is called sequentially</span>
    <span class="c1"># -----------------------------------------------</span>
    <span class="k">def</span> <span class="nf">drawframe</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="c1"># Have a progress bar shown</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">anim_indices</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="o">&gt;</span> <span class="nb">globals</span><span class="p">()[</span><span class="s2">&quot;pct_progress&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{pct:.2f}</span><span class="s1"> %&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pct</span> <span class="o">=</span> <span class="n">pct_progress</span><span class="p">))</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="s2">&quot;pct_progress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">progress_iterator</span><span class="p">)</span>

        <span class="n">x_time_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span> <span class="o">*</span> <span class="n">time_step</span> <span class="o">+</span> <span class="n">time_step</span> <span class="c1"># The first datapoint logged is at time_step, not zero.</span>
        <span class="k">if</span> <span class="n">crop_ind</span><span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">x1_time_domain</span> <span class="o">=</span> <span class="n">x_time_domain</span><span class="p">[:</span><span class="n">crop_ind</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">y1_time_domain</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:</span><span class="n">crop_ind</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">x2_time_domain</span> <span class="o">=</span> <span class="n">x_time_domain</span><span class="p">[</span><span class="n">crop_ind</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">y2_time_domain</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">crop_ind</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">line1_time_domain</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x1_time_domain</span><span class="p">,</span> <span class="n">y1_time_domain</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x2_time_domain</span> <span class="o">=</span> <span class="n">x_time_domain</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">y2_time_domain</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">line2_time_domain</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x2_time_domain</span><span class="p">,</span> <span class="n">y2_time_domain</span><span class="p">)</span>
        <span class="c1">## axs[1] (bar)</span>
        <span class="n">volts</span> <span class="o">=</span> <span class="n">voltages</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">barV</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="n">volts</span><span class="p">)</span>
        <span class="c1">## axs[2] (bar)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temperatures</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">barT</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="c1">## ax4 (line: freq domain)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fft_magns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">fft_magn</span> <span class="o">=</span> <span class="n">fft_magns</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">line_freq_domain</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fft_magn</span><span class="p">)),</span> <span class="n">fft_magn</span><span class="p">)</span>
            <span class="n">line_freq_domain</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">freqs_MHz</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">fft_magn</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="c1">## Annotations</span>
        <span class="k">if</span> <span class="n">drc</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">text_col</span> <span class="o">=</span> <span class="n">rate_cols</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">my_text</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">text_col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rate</span> <span class="o">!=</span> <span class="s1">&#39;CV&#39;</span><span class="p">:</span>
                <span class="n">rate_annotation</span> <span class="o">=</span> <span class="s1">&#39;Signal Id: </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">Rate: </span><span class="si">%s</span><span class="s1"> C&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rate_annotation</span> <span class="o">=</span> <span class="s1">&#39;Signal Id: </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">Rate: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
            <span class="n">my_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">rate_annotation</span><span class="p">)</span>    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">my_text</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">my_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;Signal Id: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">peak_heights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">x_scat</span> <span class="o">=</span> <span class="n">peak_tofs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">y_scat</span> <span class="o">=</span> <span class="n">peak_heights</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">scat_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x_scat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_scat</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">y_scat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_scat</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">scat_peaks</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">(</span><span class="n">scat_array</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line2_time_domain</span><span class="p">,</span> <span class="n">barV</span><span class="p">,</span> <span class="n">barT</span><span class="p">,</span>         

    <span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="k">as</span> <span class="nn">animation</span>
    <span class="c1"># interval is the delay between frames in milliseconds.</span>
    <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">drawframe</span><span class="p">,</span> <span class="n">interval</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">anim_indices</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">save_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.mp4&#39;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ani</span>

<span class="c1">#Signal Processing-------------------------------------</span>
<span class="c1">#------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">df_multiindex</span><span class="p">(</span><span class="n">test_id</span><span class="p">,</span> <span class="n">test_dir</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_cycling_acoustic_pnts.pkl&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_id</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">test_dir</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">file_name</span>
    <span class="n">df_cycling_acoustic_pnts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_acoustics.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_id</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">test_dir</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">file_name</span>
    <span class="n">acoustic_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="c1">#To construct dataframe out of acoustic y:</span>
    <span class="n">acoustic_headings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4000</span><span class="p">))</span>
    <span class="n">acoustic_headings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">acoustic_headings</span><span class="p">))</span>
    <span class="n">df_acoustics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">acoustic_y</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">acoustic_headings</span><span class="p">)</span>

    <span class="c1">#To concatenate df_cycling_acoustic_pnts and df_acoustics:</span>
    <span class="n">df_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_cycling_acoustic_pnts</span><span class="p">,</span> <span class="n">df_acoustics</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">,</span> <span class="s1">&#39;acoustics&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_combined</span>

<span class="k">def</span> <span class="nf">smooth_by_convolution</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="s1">&#39;rectangular&#39;</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - s is a single signal.</span>
<span class="sd">    It is prepared by introducing reflected copies of the signal in both ends so that</span>
<span class="sd">    transient parts are minimized in the begining and end part of the output signal.</span>
<span class="sd">    Those copies have length window_len.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">window_len</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># !!! Window_len must be an odd number.</span>
    <span class="k">def</span> <span class="nf">extend_signal</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        mirrored parts of the signal are introduced at the beginning and end of it.</span>
<span class="sd">        the mirroring is wrt both axes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extra_front_bit</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[</span><span class="n">window_len</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">extra_tail_bit</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">window_len</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s_extended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">extra_front_bit</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">extra_tail_bit</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s_extended</span><span class="p">)</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="n">s_extended</span> <span class="o">=</span> <span class="n">extend_signal</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kernel_type</span><span class="o">==</span><span class="s1">&#39;rectangular&#39;</span><span class="p">:</span>
        <span class="c1"># Equivalent to a moving average</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_len</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">kernel_type</span><span class="o">==</span><span class="s1">&#39;triangular&#39;</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_len</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_len</span><span class="o">/</span><span class="mi">2</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">kernel_type</span><span class="o">==</span><span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">window_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">window_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">passes</span><span class="p">):</span>
        <span class="n">s_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">s_extended</span><span class="p">,</span> <span class="n">kernel</span> <span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">s_smooth</span> <span class="o">=</span> <span class="n">s_smooth</span><span class="p">[</span><span class="n">window_len</span><span class="p">:</span><span class="o">-</span><span class="n">window_len</span><span class="p">]</span>
        <span class="n">s_extended</span> <span class="o">=</span> <span class="n">extend_signal</span><span class="p">(</span><span class="n">s_smooth</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_smooth</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">savgol_filter</span>
<span class="k">def</span> <span class="nf">smooth_by_sav_gol</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">pyorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a Savitzky-Golay filter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s_copy</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">passes</span><span class="p">):</span>
        <span class="n">s_smooth</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">s_copy</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="n">deriv</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="n">pyorder</span><span class="p">)</span>
        <span class="n">s_copy</span> <span class="o">=</span> <span class="n">s_smooth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_smooth</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span>
<span class="k">def</span> <span class="nf">signal_peaks</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">crop_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="s1">&#39;triangular&#39;</span><span class="p">,</span>
    <span class="n">n_selected_peaks</span> <span class="o">=</span> <span class="mi">9</span><span class="p">):</span>
    <span class="c1">###</span>
    <span class="n">peak_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">),</span> <span class="n">n_selected_peaks</span><span class="p">))</span>
    <span class="n">peak_heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">),</span> <span class="n">n_selected_peaks</span><span class="p">))</span>
    <span class="n">progress_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">pct_progress</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Smoothing signals. Passes = </span><span class="si">{}</span><span class="s1">. Window_len = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">passes</span><span class="p">,</span> <span class="n">window_len</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">signals</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span> <span class="o">&gt;</span> <span class="n">pct_progress</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{pct:.2f}</span><span class="s1"> %&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pct</span> <span class="o">=</span> <span class="n">pct_progress</span><span class="p">))</span>
            <span class="n">pct_progress</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">progress_iterator</span><span class="p">)</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">s_smooth</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="n">kernel_type</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="n">passes</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">indices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">s_smooth</span><span class="p">[</span><span class="n">crop_ind</span><span class="p">:])</span>
        <span class="n">indices</span> <span class="o">+=</span> <span class="n">crop_ind</span>
        <span class="n">heights</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="n">first_few_heights</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[:</span><span class="n">n_selected_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">first_few_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">n_selected_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">echo_peak_i</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">heights</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">):])</span>
        <span class="n">echo_peak_height</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[</span><span class="n">echo_peak_i</span><span class="p">]</span>
        <span class="n">echo_peak_index</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">echo_peak_i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">echo_peak_index</span> <span class="o">&gt;</span> <span class="n">first_few_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">echo_peak_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">echo_peak_height</span><span class="p">])</span>
            <span class="n">echo_peak_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">echo_peak_index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">echo_peak_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
            <span class="n">echo_peak_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
        <span class="n">peak_heights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">first_few_heights</span><span class="p">,</span> <span class="n">echo_peak_height</span><span class="p">))</span>
        <span class="n">peak_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">first_few_indices</span><span class="p">,</span> <span class="n">echo_peak_index</span><span class="p">))</span>
    <span class="n">index_to_tof_ratio</span> <span class="o">=</span> <span class="mi">10</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">s_smooth</span><span class="p">)</span>
    <span class="n">peak_tofs</span> <span class="o">=</span> <span class="n">peak_indices</span> <span class="o">*</span> <span class="n">index_to_tof_ratio</span>
    <span class="k">return</span> <span class="n">peak_heights</span><span class="p">,</span> <span class="n">peak_tofs</span>

<span class="k">def</span> <span class="nf">smooth_plot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_smooth</span><span class="p">,</span> <span class="n">acoustic_x</span><span class="p">,</span> <span class="n">plot_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    s: a signle signal</span>
<span class="sd">    s_smooth: a signle smooth signal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_range</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">acoustic_x</span><span class="p">[</span><span class="n">plot_range</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">plot_range</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">acoustic_x</span><span class="p">[</span><span class="n">plot_range</span><span class="p">],</span> <span class="n">s_smooth</span><span class="p">[</span><span class="n">plot_range</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ToF (s)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Acoustic Amplitude (a.u.)&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>

<span class="k">def</span> <span class="nf">peaks_plot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_smooth</span><span class="p">,</span> <span class="n">acoustic_x</span><span class="p">,</span> <span class="n">peak_indices</span><span class="p">,</span> <span class="n">peak_heights</span><span class="p">,</span> <span class="n">plot_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_range</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">acoustic_x</span><span class="p">[</span><span class="n">plot_range</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">plot_range</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">acoustic_x</span><span class="p">[</span><span class="n">plot_range</span><span class="p">],</span> <span class="n">s_smooth</span><span class="p">[</span><span class="n">plot_range</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">acoustic_x</span><span class="p">[</span><span class="n">peak_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">peak_indices</span><span class="p">,</span> <span class="n">plot_range</span><span class="p">)]],</span>
        <span class="n">peak_heights</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">peak_indices</span><span class="p">,</span> <span class="n">plot_range</span><span class="p">)],</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> 
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;tab:green&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ToF (s)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Acoustic Amplitude (a.u.)&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">df_with_peaks</span><span class="p">(</span>
    <span class="n">test_id</span><span class="p">,</span> <span class="n">test_dir</span><span class="p">,</span> <span class="n">slicing_indices</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">ignore_ind_list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">n_peaks</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">,</span> 
    <span class="p">):</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="n">pk_headings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_peaks</span><span class="p">))</span>
    <span class="n">pk_headings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pk_headings</span><span class="p">))</span>
    <span class="n">final_df</span> <span class="o">=</span> <span class="n">df_multiindex</span><span class="p">(</span><span class="n">test_id</span><span class="p">,</span> <span class="n">test_dir</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">slicing_indices</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">slicing_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">slicing_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ignore_ind_list</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="o">~</span><span class="n">final_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ignore_ind_list</span><span class="p">)</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">]</span>
    <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Signal Processing</span>
    <span class="n">signals</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;acoustics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">signal_len</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">crop_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="n">signal_len</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">signals</span><span class="p">[:,:</span><span class="nb">int</span><span class="p">(</span><span class="n">signal_len</span><span class="o">/</span><span class="mi">5</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">peak_heights</span><span class="p">,</span> <span class="n">peak_tofs</span> <span class="o">=</span> <span class="n">signal_peaks</span><span class="p">(</span>
        <span class="n">signals</span><span class="p">,</span> <span class="n">crop_ind</span><span class="o">=</span><span class="n">crop_ind</span><span class="p">,</span> <span class="n">n_selected_peaks</span><span class="o">=</span><span class="n">n_peaks</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="n">pk_heights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">peak_heights</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">pk_headings</span><span class="p">)</span>
    <span class="n">pk_tofs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">peak_tofs</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">pk_headings</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">],</span> <span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;acoustics&#39;</span><span class="p">],</span> <span class="n">pk_heights</span><span class="p">,</span> <span class="n">pk_tofs</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">,</span> <span class="s1">&#39;acoustics&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_heights&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_tofs&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">dQdV</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="s1">&#39;rectangular&#39;</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">V_smooth</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span>
        <span class="n">V</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="n">kernel_type</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="n">passes</span>
    <span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">Q_smooth</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span>
        <span class="n">Q</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> <span class="n">kernel_type</span><span class="o">=</span><span class="n">kernel_type</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="n">passes</span>
    <span class="p">)</span>
    <span class="n">dV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">V_smooth</span><span class="p">)</span>
    <span class="n">dQ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Q_smooth</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="mi">0</span> <span class="ow">in</span> <span class="n">dV</span><span class="p">))</span>
    <span class="n">dQdV_smooth</span> <span class="o">=</span> <span class="n">dQ</span><span class="o">/</span><span class="n">dV</span>
    <span class="c1">#np.r_ is to ensure length is preserved.</span>
    <span class="n">dQdV_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">dQdV_smooth</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dQdV_smooth</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dQdV_smooth</span>

<span class="c1">#CCCV data plotting------------------------------------</span>
<span class="c1">#------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">colorscheme</span><span class="p">(</span><span class="n">n_increments</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="n">cmap</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_increments</span><span class="p">))</span>
    <span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="k">def</span> <span class="nf">multi_cell_plot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">cell_aliases</span><span class="p">,</span> <span class="n">x_quantity</span> <span class="o">=</span> <span class="s1">&#39;Q(mAh)&#39;</span><span class="p">,</span> <span class="n">c_rates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xlims</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">18</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">relative_peaks</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">freqs_1d</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">freq_ind_pair</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">freq_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">plot_freqs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">subtitle_font_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axlabels_font_size</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">ticksize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">label_text_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
    <span class="n">save_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">visualisation_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    df must be a pandas DataFrame which is multiindex with:</span>
<span class="sd">    df.columns.levels[0] = Index([&#39;cycling&#39;, &#39;acoustics&#39;, &#39;peak_heights&#39;, &#39;peak_tofs&#39;,</span>
<span class="sd">        &#39;fft_magns&#39;, &#39;fft_freq_indices_sorted&#39;], dtype=&#39;object&#39;)</span>
<span class="sd">    cell: A list of cell names as defined in the database.</span>
<span class="sd">    cell_aliases: A dictionary where the keys are the cell names and the values are cell_aliases</span>
<span class="sd">    - which will be used instead of the cell names used in the database.</span>
<span class="sd">    Options:</span>
<span class="sd">    domain: &#39;time&#39; or &#39;freq&#39;</span>
<span class="sd">        if &#39;time&#39;; </span>
<span class="sd">        - relative_peaks: Bool</span>
<span class="sd">        if &#39;freq&#39;; must also provide an array &#39;freqs_id&#39; of the frequencies in MHz</span>
<span class="sd">        - freq_ind_pair: provide the indices of two frequencies to plot.</span>
<span class="sd">        - freq_lock: 0 or 1</span>
<span class="sd">            if 0: Use the frequency indices which produce the 1st and 2nd largest fft coefficients </span>
<span class="sd">                per cycle (i.e. filter on all of &#39;cell_id&#39;, &#39;c_rate&#39; and &#39;cycle.</span>
<span class="sd">            if 1: Use the frequency indices which produce the 1st and 2nd largest fft coefficients </span>
<span class="sd">                in the majority of cases per cell (i.e. all c_rates and all cycles per cell.)</span>
<span class="sd">        - plot_freqs: Bool</span>
<span class="sd">            Only used if freq_ind_pair is not specified.</span>
<span class="sd">            Triggers the inclusion of frequency plots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_rates</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">c_rate_for_title</span> <span class="o">=</span> <span class="s1">&#39;C-rate = </span><span class="si">{}</span><span class="s1"> C.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_rates</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">c_rate_for_title</span>  <span class="o">=</span> <span class="s1">&#39;C-rates = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> C.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_rates</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">c_rate_for_title</span>  <span class="o">=</span> <span class="s1">&#39;C-rates = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> C.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c_rates</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">domain</span><span class="o">==</span><span class="s1">&#39;time&#39;</span><span class="p">:</span>
        <span class="n">n_peaks</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">relative_peaks</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">peak_2_tof_row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">peak_last_tof_row</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">y_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;Ampl. (a.u.)</span><span class="se">\n</span><span class="s1">(second peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Ampl. (a.u.)</span><span class="se">\n</span><span class="s1">(last peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Ampl. Difference (a.u.)</span><span class="se">\n</span><span class="s1">(second and last peaks)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ToF (s)</span><span class="se">\n</span><span class="s1">(second peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ToF (s)</span><span class="se">\n</span><span class="s1">(last peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ToF Difference (s)</span><span class="se">\n</span><span class="s1">(second and last peaks)&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">relative_peaks</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">peak_2_tof_row</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">peak_last_tof_row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">y_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;Ampl. (a.u.)</span><span class="se">\n</span><span class="s1">(second peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Ampl. (a.u.)</span><span class="se">\n</span><span class="s1">(last peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ToF (s)</span><span class="se">\n</span><span class="s1">(second peak)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ToF (s)</span><span class="se">\n</span><span class="s1">(last peak)&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Time-domain peaks. </span><span class="si">{}</span><span class="se">\n</span><span class="s1">Second and last acoustic peaks.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rate_for_title</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">domain</span><span class="o">==</span><span class="s1">&#39;freq&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">freq_ind_pair</span> <span class="o">!=</span> <span class="p">():</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">y_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;FFT magn. (a.u.)</span><span class="se">\n</span><span class="s1">(</span><span class="si">{:.2f}</span><span class="s1"> MHz)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">freqs_1d</span><span class="p">[</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                <span class="s1">&#39;FFT magn. (a.u.)</span><span class="se">\n</span><span class="s1">(</span><span class="si">{:.2f}</span><span class="s1"> MHz)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">freqs_1d</span><span class="p">[</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                <span class="s1">&#39;FFT magn. difference between</span><span class="se">\n</span><span class="s1">selected freq. components (a.u.)&#39;</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="n">freq_lock</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">y_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;FFT magn. (a.u.)</span><span class="se">\n</span><span class="s1">(largest)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;FFT magn. (a.u.)</span><span class="se">\n</span><span class="s1">(second largest)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;FFT magn. difference (a.u.)</span><span class="se">\n</span><span class="s1">(largest vs second-largest)&#39;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">plot_freqs</span><span class="p">:</span>
                <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">6</span>
                <span class="n">y_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;Freq. (MHz)</span><span class="se">\n</span><span class="s1">with largest</span><span class="se">\n</span><span class="s1">FFT magn.&#39;</span>
                <span class="p">)</span>
                <span class="n">y_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;Freq. (MHz)</span><span class="se">\n</span><span class="s1">with second-largest</span><span class="se">\n</span><span class="s1">FFT magn.&#39;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">freq_lock</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">y_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;FFT magn. (a.u.)</span><span class="se">\n</span><span class="s1">(largest overall)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;FFT magn. (a.u.)</span><span class="se">\n</span><span class="s1">(second largest overall)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;FFT magn. difference (a.u.)</span><span class="se">\n</span><span class="s1">(largest vs second-largest)&#39;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">plot_freqs</span><span class="p">:</span>
                <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">6</span>
                <span class="n">y_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;Freq. (MHz) with</span><span class="se">\n</span><span class="s1">largest overall</span><span class="se">\n</span><span class="s1">FFT magn.&#39;</span>
                <span class="p">)</span>
                <span class="n">y_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;Freq. (MHz) with</span><span class="se">\n</span><span class="s1">second-largest overall</span><span class="se">\n</span><span class="s1">FFT magn.&#39;</span>
                <span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Freq-domain. </span><span class="si">{}</span><span class="se">\n</span><span class="s1">First and second most dominant frequency components.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rate_for_title</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">c_rate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_rates</span><span class="p">):</span>
        <span class="n">filter1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">][</span><span class="s1">&#39;C-Rate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c_rate</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filter1</span><span class="p">,</span> <span class="s1">&#39;Cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">c_rate</span> <span class="o">==</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">col_scheme</span> <span class="o">=</span> <span class="s1">&#39;Purples&#39;</span>
        <span class="k">elif</span> <span class="n">c_rate</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">col_scheme</span> <span class="o">=</span> <span class="s1">&#39;Oranges&#39;</span>
        <span class="k">elif</span> <span class="n">c_rate</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">col_scheme</span> <span class="o">=</span> <span class="s1">&#39;Blues&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)):</span>
            <span class="n">cell_id</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">filter2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">][</span><span class="s1">&#39;Cell_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_id</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colorscheme</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">),</span> <span class="n">col_scheme</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">cycles</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">cycle</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># To display cycles starting at 1 instead of 0</span>
                <span class="n">filter3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">][</span><span class="s1">&#39;Cycle&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cycle</span>
                <span class="nb">filter</span> <span class="o">=</span> <span class="n">filter1</span> <span class="o">&amp;</span> <span class="n">filter2</span> <span class="o">&amp;</span> <span class="n">filter3</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="n">x_quantity</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="c1"># For each C rate use a separate axs to produce labels.</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;V(V)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;V(V)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;V(V)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cycling&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;V(V)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>             
                <span class="k">if</span> <span class="n">domain</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">relative_peaks</span><span class="p">:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">-</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_tofs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">-</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_tofs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">peak_2_tof_row</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_tofs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">peak_last_tof_row</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_tofs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_peaks</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">domain</span> <span class="o">==</span> <span class="s1">&#39;freq&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">freq_ind_pair</span> <span class="o">!=</span> <span class="p">():</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">-</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])]),</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">freq_lock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Use the frequency indices which produce the 1st and 2nd largest</span>
                        <span class="c1"># fft coefficients per subset with filter on c_rate, cell_id and cycle.</span>
                        <span class="n">sorted_fft_magns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
                        <span class="n">freqs_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">freqs_1d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_freq_indices_sorted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()])</span>
                        <span class="n">freqs_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">freqs_1d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_freq_indices_sorted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()])</span>                        
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">sorted_fft_magns</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">sorted_fft_magns</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">sorted_fft_magns</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sorted_fft_magns</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">plot_freqs</span><span class="p">:</span>
                            <span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                <span class="n">x</span><span class="p">,</span>
                                <span class="n">freqs_1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                <span class="n">x</span><span class="p">,</span>
                                <span class="n">freqs_2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                            <span class="p">)</span>
                        
                    <span class="k">elif</span> <span class="n">freq_lock</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Find the frequency indices which produce the 1st and 2nd largest</span>
                        <span class="c1"># fft coefficients in the majority of cases per cell</span>
                        <span class="n">freq_ind1</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_freq_indices_sorted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filter2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">freq_ind2</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_freq_indices_sorted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filter2</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind1</span><span class="p">)],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind2</span><span class="p">)],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind1</span><span class="p">)]</span><span class="o">-</span>
                            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fft_magns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq_ind2</span><span class="p">)]),</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">plot_freqs</span><span class="p">:</span>
                            <span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                <span class="n">x</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">freqs_1d</span><span class="p">[</span><span class="n">freq_ind1</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                <span class="n">x</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">freqs_1d</span><span class="p">[</span><span class="n">freq_ind2</span><span class="p">]),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                            <span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span> <span class="o">=</span> <span class="n">handles</span><span class="p">,</span> 
                <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cycle (</span><span class="si">{}</span><span class="s2">C)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rate</span><span class="p">),</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span> <span class="o">=</span> <span class="n">handles</span><span class="p">,</span> 
                <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cycle (</span><span class="si">{}</span><span class="s2">C)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rate</span><span class="p">),</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span> <span class="o">=</span> <span class="n">handles</span><span class="p">,</span>
                <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cycle (</span><span class="si">{}</span><span class="s2">C)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_rate</span><span class="p">),</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="n">label_text_size</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="s1">&#39;SoC&#39;</span> <span class="ow">in</span> <span class="n">x_quantity</span><span class="p">:</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="s1">&#39;SoC&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="n">x_quantity</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;V(V)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">axlabels_font_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rows</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">axlabels_font_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)):</span>
        <span class="n">cell_id</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">axlabels_font_size</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlims</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cell </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell_aliases</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">subtitle_font_size</span><span class="p">)</span>
    
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">ticksize</span><span class="p">)</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">ticksize</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">align_ylabels</span><span class="p">(</span><span class="n">axs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">f</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">title_font_size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_filename</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">visualisation_path</span><span class="p">,</span> <span class="n">save_filename</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_axes</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">axs</span><span class="p">)</span>

<span class="c1">#EIS---------------------------------------------------</span>
<span class="c1">#------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span>
<span class="k">def</span> <span class="nf">plot_deltaQ_dueto_eis</span><span class="p">(</span><span class="n">IO_path</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="p">(</span><span class="mf">2.75</span><span class="p">,</span> <span class="mf">4.25</span><span class="p">),</span> <span class="n">save_path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Read in data</span>
    <span class="c1"># --------------------------------</span>
    <span class="c1"># Load the eis_tests dictionary</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;eis_tests_dict.pkl&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IO_path</span><span class="p">,</span> <span class="s1">&#39;eis&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">SonicBatt.constants</span> <span class="kn">import</span> <span class="n">my_unpickler</span>
        <span class="n">eis_tests</span> <span class="o">=</span> <span class="n">my_unpickler</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">eis_tests</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="c1"># frequencies are always the same. Just pick one frequency vector from all the data.</span>
    <span class="n">n_eis_per_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eis_tests</span><span class="p">[</span><span class="mf">3.1</span><span class="p">][</span><span class="s1">&#39;EIS_list&#39;</span><span class="p">])</span>
    <span class="c1"># Create 2D ndarrays</span>
    <span class="n">Q_changes_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span><span class="n">n_eis_per_test</span><span class="p">))</span>
    <span class="n">pre_OCVs_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span><span class="n">n_eis_per_test</span><span class="p">))</span>
    <span class="n">post_OCVs_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span><span class="n">n_eis_per_test</span><span class="p">))</span>
    <span class="n">temps_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span><span class="n">n_eis_per_test</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
        <span class="n">EIS_list</span> <span class="o">=</span> <span class="n">eis_tests</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;EIS_list&#39;</span><span class="p">]</span>
        <span class="n">Q_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_eis_per_test</span><span class="p">)</span>
        <span class="n">pre_OCVs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_eis_per_test</span><span class="p">)</span>
        <span class="n">post_OCVs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_eis_per_test</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">EIS_obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">EIS_list</span><span class="p">):</span>
            <span class="n">Q_changes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">EIS_obj</span><span class="o">.</span><span class="n">Q_change</span>
            <span class="n">pre_OCVs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">EIS_obj</span><span class="o">.</span><span class="n">pre_OCV</span>
            <span class="n">post_OCVs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">EIS_obj</span><span class="o">.</span><span class="n">post_OCV</span>
            <span class="n">temps_all</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">EIS_obj</span><span class="o">.</span><span class="n">pre_OCV_df</span><span class="p">[</span><span class="s1">&#39;Temp(degC)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Q_changes_all</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Q_changes</span>
        <span class="n">pre_OCVs_all</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">pre_OCVs</span>
        <span class="n">post_OCVs_all</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">post_OCVs</span>
    <span class="c1"># --------------------------------</span>
    <span class="c1"># Read in regression model</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;model_polyfeatures.sav&#39;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IO_path</span><span class="p">,</span> <span class="s1">&#39;eis&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>        
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">poly_features</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;model_deltaQ_ocvEIS.sav&#39;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IO_path</span><span class="p">,</span> <span class="s1">&#39;eis&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lin_reg</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c1"># --------------------------------</span>
    <span class="c1"># Plot (coloured by temperature)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">temps_all</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">temps_all</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">temp_colorsheme</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">Reds</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)))</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
        <span class="n">Q_changes</span> <span class="o">=</span> <span class="n">Q_changes_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pre_OCVs</span> <span class="o">=</span> <span class="n">pre_OCVs_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">post_OCVs</span> <span class="o">=</span><span class="n">post_OCVs_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dOCV</span> <span class="o">=</span> <span class="p">(</span><span class="n">post_OCVs</span> <span class="o">-</span> <span class="n">pre_OCVs</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span> <span class="c1">#converting to mV</span>
        <span class="n">temps</span> <span class="o">=</span> <span class="n">temps_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">temp_colorsheme</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">temps</span><span class="p">))</span>
        <span class="c1"># axs[0].scatter(pre_OCVs, dOCV, label= &#39;~{:.1f} V&#39;.format(key))</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pre_OCVs</span><span class="p">,</span> <span class="n">dOCV</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pre_OCVs</span><span class="p">,</span> <span class="n">Q_changes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;OCV before EIS&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;(OCV) (mV)&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Q (mAh)&#39;</span><span class="p">)</span>
    <span class="n">ylims</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="c1"># Draw horizontal line at Q = 0</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>

    <span class="c1"># Draw regression line</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">x_test_poly</span> <span class="o">=</span> <span class="n">poly_features</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
    <span class="n">y_test_preds</span> <span class="o">=</span> <span class="n">lin_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test_poly</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span><span class="n">y_test_preds</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="c1"># Fix limits in case they were distorted</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlims</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylims</span><span class="p">)</span>
    <span class="c1"># Colorbar</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">temp_colorsheme</span><span class="p">),</span> <span class="n">ax</span> <span class="o">=</span><span class="n">axs</span><span class="p">,</span> 
                <span class="n">location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Temp ($^</span><span class="se">\\</span><span class="s1">circ$C)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">save_path</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

<span class="c1">#Machine Learning--------------------------------------</span>
<span class="c1">#------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform feature normalisation on individual features.</span>
<span class="sd">    Scale each feature of the training set to be in the range 0 to 1.</span>
<span class="sd">    Test set features can be outside the 0-1 range.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#In the past I had issues with my input arguments being changed globally by the function because they are mutable ndarrays.</span>
    <span class="c1">#To avoid this, create new parameters to store the function outputs.</span>
    <span class="n">x_train_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1">#Initialise arrays</span>
    <span class="n">feature_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">feature_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">feature_max</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1">#Look at the features column-wise</span>
        <span class="n">feature_min</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">difference</span> <span class="o">=</span> <span class="n">feature_max</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">feature_min</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">x_train_return</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">feature_min</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">difference</span> <span class="k">if</span> <span class="n">difference</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="c1">#Check if test data has been provided. If so, Normalise the test data, one</span>
    <span class="c1">#feature at a time based on the scaling metrics obtained from the training set.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_test_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">difference</span> <span class="o">=</span> <span class="n">feature_max</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">feature_min</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">x_test_return</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_test</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">feature_min</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">difference</span> <span class="k">if</span> <span class="n">difference</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_test_return</span> <span class="o">=</span> <span class="n">x_test</span>
    <span class="k">return</span> <span class="n">x_train_return</span><span class="p">,</span> <span class="n">x_test_return</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">SonicBatt</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Elias Galiounas.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>